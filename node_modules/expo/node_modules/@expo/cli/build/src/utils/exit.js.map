{"version":3,"sources":["../../../src/utils/exit.ts"],"sourcesContent":["import { ChildProcess } from 'node:child_process';\nimport process from 'node:process';\n\nimport { guardAsync } from './fn';\nimport { warn } from '../log';\n\nconst debug = require('debug')('expo:utils:exit') as typeof console.log;\n\n// NOTE: This is an internal method, not designed to be exposed. It's also our only way to get this info\ndeclare global {\n  namespace NodeJS {\n    interface Process {\n      _getActiveHandles(): readonly any[];\n    }\n  }\n}\n\ntype AsyncExitHook = (signal: NodeJS.Signals) => void | Promise<void>;\n\nconst PRE_EXIT_SIGNALS: NodeJS.Signals[] = ['SIGHUP', 'SIGINT', 'SIGTERM', 'SIGBREAK'];\n\n// We create a queue since Node.js throws an error if we try to append too many listeners:\n// (node:4405) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 SIGINT listeners added to [process]. Use emitter.setMaxListeners() to increase limit\nconst queue: AsyncExitHook[] = [];\n\nlet unsubscribe: (() => void) | null = null;\n\n/** Add functions that run before the process exits. Returns a function for removing the listeners. */\nexport function installExitHooks(asyncExitHook: AsyncExitHook): () => void {\n  // We need to instantiate the master listener the first time the queue is used.\n  if (!queue.length) {\n    // Track the master listener so we can remove it later.\n    unsubscribe = attachMasterListener();\n  }\n\n  queue.push(asyncExitHook);\n\n  return () => {\n    const index = queue.indexOf(asyncExitHook);\n    if (index >= 0) {\n      queue.splice(index, 1);\n    }\n    // Clean up the master listener if we don't need it anymore.\n    if (!queue.length) {\n      unsubscribe?.();\n    }\n  };\n}\n\n// Create a function that runs before the process exits and guards against running multiple times.\nfunction createExitHook(signal: NodeJS.Signals) {\n  return guardAsync(async () => {\n    debug(`pre-exit (signal: ${signal}, queue length: ${queue.length})`);\n\n    for (const [index, hookAsync] of Object.entries(queue)) {\n      try {\n        await hookAsync(signal);\n      } catch (error: any) {\n        debug(`Error in exit hook: %O (queue: ${index})`, error);\n      }\n    }\n\n    debug(`post-exit (code: ${process.exitCode ?? 0})`);\n\n    process.exit();\n  });\n}\n\nfunction attachMasterListener() {\n  const hooks: [NodeJS.Signals, () => any][] = [];\n  for (const signal of PRE_EXIT_SIGNALS) {\n    const hook = createExitHook(signal);\n    hooks.push([signal, hook]);\n    process.on(signal, hook);\n  }\n  return () => {\n    for (const [signal, hook] of hooks) {\n      process.removeListener(signal, hook);\n    }\n  };\n}\n\n/**\n * Monitor if the current process is exiting before the delay is reached.\n * If there are active resources, the process will be forced to exit after the delay is reached.\n *\n * @see https://nodejs.org/docs/latest-v18.x/api/process.html#processgetactiveresourcesinfo\n */\nexport function ensureProcessExitsAfterDelay(waitUntilExitMs = 10000, startedAtMs = Date.now()) {\n  // Create a list of the expected active resources before exiting.\n  // Note, the order is undeterministic\n  const expectedResources = [\n    process.stdout.isTTY ? 'TTYWrap' : 'PipeWrap',\n    process.stderr.isTTY ? 'TTYWrap' : 'PipeWrap',\n    process.stdin.isTTY ? 'TTYWrap' : 'PipeWrap',\n  ];\n  // Check active resources, besides the TTYWrap/PipeWrap (process.stdin, process.stdout, process.stderr)\n  const activeResources = process.getActiveResourcesInfo() as string[];\n  // Filter the active resource list by subtracting the expected resources, in undeterministic order\n  const unexpectedActiveResources = activeResources.filter((activeResource) => {\n    const index = expectedResources.indexOf(activeResource);\n    if (index >= 0) {\n      expectedResources.splice(index, 1);\n      return false;\n    }\n\n    return true;\n  });\n\n  // Check if only Timeouts remain (no blocking resources like ProcessWrap/PipeWrap)\n  const hasBlockingResources = unexpectedActiveResources.some(\n    (resource) => resource !== 'Timeout' && resource !== 'CloseReq'\n  );\n\n  const canExitProcess = !unexpectedActiveResources.length || !hasBlockingResources;\n  if (canExitProcess) {\n    if (unexpectedActiveResources.length && !hasBlockingResources) {\n      debug('only non-blocking resources remain (Timeout/CloseReq), process can safely exit');\n    } else {\n      debug('no active resources detected, process can safely exit');\n    }\n    return;\n  } else {\n    debug(\n      `process is trying to exit, but is stuck on unexpected active resources:`,\n      unexpectedActiveResources\n    );\n  }\n\n  // Check if the process needs to be force-closed\n  const elapsedTime = Date.now() - startedAtMs;\n  if (elapsedTime > waitUntilExitMs) {\n    debug('active handles detected past the exit delay, forcefully exiting:', activeResources);\n    tryWarnActiveProcesses();\n    return process.exit(0);\n  }\n\n  const timeoutId = setTimeout(() => {\n    // Ensure the timeout is cleared before checking the active resources\n    clearTimeout(timeoutId);\n    // Check if the process can exit\n    ensureProcessExitsAfterDelay(waitUntilExitMs, startedAtMs);\n\n    // setTimeout is using the global definitions from React Native which is missing the unref method in Node.js.\n  }, 100) as unknown as NodeJS.Timeout;\n\n  // Unref the timeout so it doesn't prevent the process from exiting naturally\n  // when this timeout is the only remaining active resource\n  timeoutId.unref();\n}\n\n/**\n * Try to warn the user about unexpected active processes running in the background.\n * This uses the internal `process._getActiveHandles` method, within a try-catch block.\n * If active child processes are detected, the commands of these processes are logged.\n *\n * @example ```bash\n * Done writing bundle output\n * Detected 2 processes preventing Expo from exiting, forcefully exiting now.\n *   - node /Users/cedric/../node_modules/nativewind/dist/metro/tailwind/v3/child.js\n *   - node /Users/cedric/../node_modules/nativewind/dist/metro/tailwind/v3/child.js\n * ```\n */\nfunction tryWarnActiveProcesses() {\n  const activeProcesses: string[] = [];\n  const handleSummary: Record<string, number> = {};\n  const timeoutDetails: string[] = [];\n\n  try {\n    const handles = process._getActiveHandles();\n\n    // Categorize handles by their constructor name\n    for (const handle of handles) {\n      const name = handle?.constructor?.name ?? 'Unknown';\n      handleSummary[name] = (handleSummary[name] ?? 0) + 1;\n\n      // Collect ChildProcess command info\n      if (handle instanceof ChildProcess) {\n        activeProcesses.push(handle.spawnargs.join(' '));\n      }\n\n      // Try to get more info about Timeout handles\n      if (name === 'Timeout') {\n        try {\n          // Attempt to get callback name or source info\n          const callback = handle._onTimeout ?? handle._repeat;\n          const callbackName = callback?.name || '<anonymous>';\n          const delay = handle._idleTimeout ?? 'unknown';\n          timeoutDetails.push(`Timeout(${delay}ms, fn: ${callbackName})`);\n        } catch {\n          timeoutDetails.push('Timeout(details unavailable)');\n        }\n      }\n    }\n\n    // Log detailed handle info when debug is enabled\n    debug('active handles by type:', handleSummary);\n    if (timeoutDetails.length) {\n      debug('timeout details:', timeoutDetails);\n    }\n  } catch (error) {\n    debug('failed to get active process information:', error);\n  }\n\n  if (!activeProcesses.length) {\n    warn('Something prevented Expo from exiting, forcefully exiting now.');\n    // Log handle summary when no specific processes are identified\n    if (Object.keys(handleSummary).length > 0) {\n      debug('handle summary (use DEBUG=expo:utils:exit for details):', handleSummary);\n    }\n  } else {\n    const singularOrPlural =\n      activeProcesses.length === 1 ? '1 process' : `${activeProcesses.length} processes`;\n\n    warn(`Detected ${singularOrPlural} preventing Expo from exiting, forcefully exiting now.`);\n    warn('  - ' + activeProcesses.join('\\n  - '));\n  }\n}\n"],"names":["ensureProcessExitsAfterDelay","installExitHooks","debug","require","PRE_EXIT_SIGNALS","queue","unsubscribe","asyncExitHook","length","attachMasterListener","push","index","indexOf","splice","createExitHook","signal","guardAsync","hookAsync","Object","entries","error","process","exitCode","exit","hooks","hook","on","removeListener","waitUntilExitMs","startedAtMs","Date","now","expectedResources","stdout","isTTY","stderr","stdin","activeResources","getActiveResourcesInfo","unexpectedActiveResources","filter","activeResource","hasBlockingResources","some","resource","canExitProcess","elapsedTime","tryWarnActiveProcesses","timeoutId","setTimeout","clearTimeout","unref","activeProcesses","handleSummary","timeoutDetails","handles","_getActiveHandles","handle","name","constructor","ChildProcess","spawnargs","join","callback","_onTimeout","_repeat","callbackName","delay","_idleTimeout","warn","keys","singularOrPlural"],"mappings":"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"}