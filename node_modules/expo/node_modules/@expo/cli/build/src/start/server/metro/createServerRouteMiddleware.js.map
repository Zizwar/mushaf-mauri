{"version":3,"sources":["../../../../../src/start/server/metro/createServerRouteMiddleware.ts"],"sourcesContent":["/**\n * Copyright Â© 2022 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport type { ProjectConfig } from '@expo/config';\nimport type { MiddlewareSettings } from 'expo-server';\nimport { createRequestHandler } from 'expo-server/adapter/http';\nimport { ImmutableRequest, type RouteInfo } from 'expo-server/private';\nimport path from 'path';\nimport resolveFrom from 'resolve-from';\n\nimport { fetchManifest } from './fetchRouterManifest';\nimport { getErrorOverlayHtmlAsync } from './metroErrorInterface';\nimport {\n  warnInvalidWebOutput,\n  warnInvalidMiddlewareOutput,\n  warnInvalidMiddlewareMatcherSettings,\n} from './router';\nimport { CommandError } from '../../../utils/errors';\n\nconst debug = require('debug')('expo:start:server:metro') as typeof console.log;\n\nexport function createRouteHandlerMiddleware(\n  projectRoot: string,\n  options: {\n    appDir: string;\n    routerRoot: string;\n    getStaticPageAsync: (\n      pathname: string,\n      route: RouteInfo<RegExp>,\n      request?: ImmutableRequest\n    ) => Promise<{ content: string }>;\n    bundleApiRoute: (\n      functionFilePath: string\n    ) => Promise<null | Record<string, Function> | Response>;\n    executeLoaderAsync: (\n      route: RouteInfo<RegExp>,\n      request: ImmutableRequest\n    ) => Promise<Response | undefined>;\n    config: ProjectConfig;\n    headers: Record<string, string | string[]>;\n  } & import('@expo/router-server/build/routes-manifest').Options\n) {\n  if (!resolveFrom.silent(projectRoot, 'expo-router')) {\n    throw new CommandError(\n      `static and server rendering requires the expo-router package to be installed in your project. Either install the expo-router package or change 'web.output' to 'single' in your app.json.`\n    );\n  }\n\n  return createRequestHandler(\n    { build: '', isDevelopment: true },\n    {\n      async getRoutesManifest() {\n        const manifest = await fetchManifest(projectRoot, options);\n        debug('manifest', manifest);\n\n        const { exp } = options.config;\n\n        if (manifest && exp.extra?.router?.unstable_useServerDataLoaders === true) {\n          // In development, set `loader` property on all HTML routes. We can't know which routes\n          // have loaders without bundling via Metro to detect exports. In production, this is\n          // populated by `exportStaticAsync.ts` after bundling.\n          // At runtime, `getLoaderData()` returns a 404 response if no loader exists.\n          for (const route of manifest.htmlRoutes) {\n            route.loader = `_expo/loaders${route.page}.js`;\n          }\n        }\n\n        // NOTE: no app dir if null\n        // TODO: Redirect to 404 page\n        return (\n          manifest ?? {\n            // Support the onboarding screen if there's no manifest\n            htmlRoutes: [\n              {\n                file: 'index.js',\n                page: '/index',\n                routeKeys: {},\n                namedRegex: /^\\/(?:index)?\\/?$/i,\n              },\n            ],\n            apiRoutes: [],\n            notFoundRoutes: [],\n            redirects: [],\n            rewrites: [],\n          }\n        );\n      },\n      async getHtml(request, route) {\n        try {\n          const { exp } = options.config;\n          const isSSREnabled =\n            exp.web?.output === 'server' && exp.extra?.router?.unstable_useServerRendering === true;\n\n          const { content } = await options.getStaticPageAsync(\n            request.url,\n            route,\n            isSSREnabled ? new ImmutableRequest(request) : undefined\n          );\n          return content;\n        } catch (error: any) {\n          // Forward the Metro server response as-is. It won't be pretty, but at least it will be accurate.\n\n          try {\n            return new Response(\n              await getErrorOverlayHtmlAsync({\n                error,\n                projectRoot,\n                routerRoot: options.routerRoot,\n              }),\n              {\n                status: 500,\n                headers: {\n                  'Content-Type': 'text/html',\n                },\n              }\n            );\n          } catch (staticError: any) {\n            debug('Failed to render static error overlay:', staticError);\n            // Fallback error for when Expo Router is misconfigured in the project.\n            return new Response(\n              '<span><h3>Internal Error:</h3><b>Project is not setup correctly for static rendering (check terminal for more info):</b><br/>' +\n                error.message +\n                '<br/><br/>' +\n                staticError.message +\n                '</span>',\n              {\n                status: 500,\n                headers: {\n                  'Content-Type': 'text/html',\n                },\n              }\n            );\n          }\n        }\n      },\n      async handleRouteError(error) {\n        // NOTE(@kitten): ExpoError is currently not exposed by expo-server just yet\n        if (error && typeof error === 'object' && error.name === 'ExpoError') {\n          // TODO(@krystofwoldrich): Can we show code snippet of the handler?\n          // NOTE(@krystofwoldrich): Removing stack since to avoid confusion. The error is not in the server code.\n          delete error.stack;\n        }\n\n        const htmlServerError = await getErrorOverlayHtmlAsync({\n          error,\n          projectRoot,\n          routerRoot: options.routerRoot!,\n        });\n\n        return new Response(htmlServerError, {\n          status: 500,\n          headers: {\n            'Content-Type': 'text/html',\n          },\n        });\n      },\n      async getApiRoute(route) {\n        const { exp } = options.config;\n        if (exp.web?.output !== 'server') {\n          warnInvalidWebOutput();\n        }\n\n        // TODO(@kitten): Unify with MetroBundlerDevServer#exportExpoRouterApiRoutesAsync\n        const resolvedFunctionPath = path.isAbsolute(route.file)\n          ? route.file\n          : path.join(options.appDir, route.file);\n        try {\n          debug(`Bundling API route at: ${resolvedFunctionPath}`);\n          return await options.bundleApiRoute(resolvedFunctionPath!);\n        } catch (error: any) {\n          return new Response(\n            'Failed to load API Route: ' + resolvedFunctionPath + '\\n\\n' + error.message,\n            {\n              status: 500,\n              headers: {\n                'Content-Type': 'text/html',\n              },\n            }\n          );\n        }\n      },\n      async getMiddleware(route) {\n        const { exp } = options.config;\n\n        if (!options.unstable_useServerMiddleware) {\n          return {\n            default: () => {\n              throw new CommandError(\n                'Server middleware is not enabled. Add unstable_useServerMiddleware: true to your `expo-router` plugin config.'\n              );\n            },\n          };\n        }\n\n        if (exp.web?.output !== 'server') {\n          warnInvalidMiddlewareOutput();\n          return {\n            default: () => {\n              console.warn(\n                'Server middleware is only supported when web.output is set to \"server\" in your app config'\n              );\n            },\n          };\n        }\n\n        // TODO(@kitten): Unify with MetroBundlerDevServer#exportMiddlewareAsync\n        const resolvedFunctionPath = path.isAbsolute(route.file)\n          ? route.file\n          : path.join(options.appDir, route.file);\n        try {\n          debug(`Bundling middleware at: ${resolvedFunctionPath}`);\n          const middlewareModule = (await options.bundleApiRoute(resolvedFunctionPath!)) as any;\n\n          if ((middlewareModule.unstable_settings as MiddlewareSettings)?.matcher) {\n            warnInvalidMiddlewareMatcherSettings(middlewareModule.unstable_settings?.matcher);\n          }\n\n          return middlewareModule;\n        } catch (error: any) {\n          return new Response(\n            'Failed to load middleware: ' + resolvedFunctionPath + '\\n\\n' + error.message,\n            {\n              status: 500,\n              headers: {\n                'Content-Type': 'text/html',\n              },\n            }\n          );\n        }\n      },\n      async getLoaderData(request, route) {\n        const response = await options.executeLoaderAsync(route, new ImmutableRequest(request));\n        return response ?? new Response(null, { status: 404 });\n      },\n    }\n  );\n}\n"],"names":["createRouteHandlerMiddleware","debug","require","projectRoot","options","resolveFrom","silent","CommandError","createRequestHandler","build","isDevelopment","getRoutesManifest","exp","manifest","fetchManifest","config","extra","router","unstable_useServerDataLoaders","route","htmlRoutes","loader","page","file","routeKeys","namedRegex","apiRoutes","notFoundRoutes","redirects","rewrites","getHtml","request","isSSREnabled","web","output","unstable_useServerRendering","content","getStaticPageAsync","url","ImmutableRequest","undefined","error","Response","getErrorOverlayHtmlAsync","routerRoot","status","headers","staticError","message","handleRouteError","name","stack","htmlServerError","getApiRoute","warnInvalidWebOutput","resolvedFunctionPath","path","isAbsolute","join","appDir","bundleApiRoute","getMiddleware","unstable_useServerMiddleware","default","warnInvalidMiddlewareOutput","console","warn","middlewareModule","unstable_settings","matcher","warnInvalidMiddlewareMatcherSettings","getLoaderData","response","executeLoaderAsync"],"mappings":"AAAA;;;;;CAKC;;;;+BAoBeA;;;eAAAA;;;;yBAhBqB;;;;;;;yBACY;;;;;;;gEAChC;;;;;;;gEACO;;;;;;qCAEM;qCACW;wBAKlC;wBACsB;;;;;;AAE7B,MAAMC,QAAQC,QAAQ,SAAS;AAExB,SAASF,6BACdG,WAAmB,EACnBC,OAiB+D;IAE/D,IAAI,CAACC,sBAAW,CAACC,MAAM,CAACH,aAAa,gBAAgB;QACnD,MAAM,IAAII,oBAAY,CACpB,CAAC,yLAAyL,CAAC;IAE/L;IAEA,OAAOC,IAAAA,4BAAoB,EACzB;QAAEC,OAAO;QAAIC,eAAe;IAAK,GACjC;QACE,MAAMC;gBAMYC,mBAAAA;YALhB,MAAMC,WAAW,MAAMC,IAAAA,kCAAa,EAACX,aAAaC;YAClDH,MAAM,YAAYY;YAElB,MAAM,EAAED,GAAG,EAAE,GAAGR,QAAQW,MAAM;YAE9B,IAAIF,YAAYD,EAAAA,aAAAA,IAAII,KAAK,sBAATJ,oBAAAA,WAAWK,MAAM,qBAAjBL,kBAAmBM,6BAA6B,MAAK,MAAM;gBACzE,uFAAuF;gBACvF,oFAAoF;gBACpF,sDAAsD;gBACtD,4EAA4E;gBAC5E,KAAK,MAAMC,SAASN,SAASO,UAAU,CAAE;oBACvCD,MAAME,MAAM,GAAG,CAAC,aAAa,EAAEF,MAAMG,IAAI,CAAC,GAAG,CAAC;gBAChD;YACF;YAEA,2BAA2B;YAC3B,6BAA6B;YAC7B,OACET,YAAY;gBACV,uDAAuD;gBACvDO,YAAY;oBACV;wBACEG,MAAM;wBACND,MAAM;wBACNE,WAAW,CAAC;wBACZC,YAAY;oBACd;iBACD;gBACDC,WAAW,EAAE;gBACbC,gBAAgB,EAAE;gBAClBC,WAAW,EAAE;gBACbC,UAAU,EAAE;YACd;QAEJ;QACA,MAAMC,SAAQC,OAAO,EAAEZ,KAAK;YAC1B,IAAI;oBAGAP,UAAgCA,mBAAAA;gBAFlC,MAAM,EAAEA,GAAG,EAAE,GAAGR,QAAQW,MAAM;gBAC9B,MAAMiB,eACJpB,EAAAA,WAAAA,IAAIqB,GAAG,qBAAPrB,SAASsB,MAAM,MAAK,YAAYtB,EAAAA,aAAAA,IAAII,KAAK,sBAATJ,oBAAAA,WAAWK,MAAM,qBAAjBL,kBAAmBuB,2BAA2B,MAAK;gBAErF,MAAM,EAAEC,OAAO,EAAE,GAAG,MAAMhC,QAAQiC,kBAAkB,CAClDN,QAAQO,GAAG,EACXnB,OACAa,eAAe,IAAIO,CAAAA,UAAe,kBAAC,CAACR,WAAWS;gBAEjD,OAAOJ;YACT,EAAE,OAAOK,OAAY;gBACnB,iGAAiG;gBAEjG,IAAI;oBACF,OAAO,IAAIC,SACT,MAAMC,IAAAA,6CAAwB,EAAC;wBAC7BF;wBACAtC;wBACAyC,YAAYxC,QAAQwC,UAAU;oBAChC,IACA;wBACEC,QAAQ;wBACRC,SAAS;4BACP,gBAAgB;wBAClB;oBACF;gBAEJ,EAAE,OAAOC,aAAkB;oBACzB9C,MAAM,0CAA0C8C;oBAChD,uEAAuE;oBACvE,OAAO,IAAIL,SACT,kIACED,MAAMO,OAAO,GACb,eACAD,YAAYC,OAAO,GACnB,WACF;wBACEH,QAAQ;wBACRC,SAAS;4BACP,gBAAgB;wBAClB;oBACF;gBAEJ;YACF;QACF;QACA,MAAMG,kBAAiBR,KAAK;YAC1B,4EAA4E;YAC5E,IAAIA,SAAS,OAAOA,UAAU,YAAYA,MAAMS,IAAI,KAAK,aAAa;gBACpE,mEAAmE;gBACnE,wGAAwG;gBACxG,OAAOT,MAAMU,KAAK;YACpB;YAEA,MAAMC,kBAAkB,MAAMT,IAAAA,6CAAwB,EAAC;gBACrDF;gBACAtC;gBACAyC,YAAYxC,QAAQwC,UAAU;YAChC;YAEA,OAAO,IAAIF,SAASU,iBAAiB;gBACnCP,QAAQ;gBACRC,SAAS;oBACP,gBAAgB;gBAClB;YACF;QACF;QACA,MAAMO,aAAYlC,KAAK;gBAEjBP;YADJ,MAAM,EAAEA,GAAG,EAAE,GAAGR,QAAQW,MAAM;YAC9B,IAAIH,EAAAA,WAAAA,IAAIqB,GAAG,qBAAPrB,SAASsB,MAAM,MAAK,UAAU;gBAChCoB,IAAAA,4BAAoB;YACtB;YAEA,iFAAiF;YACjF,MAAMC,uBAAuBC,eAAI,CAACC,UAAU,CAACtC,MAAMI,IAAI,IACnDJ,MAAMI,IAAI,GACViC,eAAI,CAACE,IAAI,CAACtD,QAAQuD,MAAM,EAAExC,MAAMI,IAAI;YACxC,IAAI;gBACFtB,MAAM,CAAC,uBAAuB,EAAEsD,sBAAsB;gBACtD,OAAO,MAAMnD,QAAQwD,cAAc,CAACL;YACtC,EAAE,OAAOd,OAAY;gBACnB,OAAO,IAAIC,SACT,+BAA+Ba,uBAAuB,SAASd,MAAMO,OAAO,EAC5E;oBACEH,QAAQ;oBACRC,SAAS;wBACP,gBAAgB;oBAClB;gBACF;YAEJ;QACF;QACA,MAAMe,eAAc1C,KAAK;gBAanBP;YAZJ,MAAM,EAAEA,GAAG,EAAE,GAAGR,QAAQW,MAAM;YAE9B,IAAI,CAACX,QAAQ0D,4BAA4B,EAAE;gBACzC,OAAO;oBACLC,SAAS;wBACP,MAAM,IAAIxD,oBAAY,CACpB;oBAEJ;gBACF;YACF;YAEA,IAAIK,EAAAA,WAAAA,IAAIqB,GAAG,qBAAPrB,SAASsB,MAAM,MAAK,UAAU;gBAChC8B,IAAAA,mCAA2B;gBAC3B,OAAO;oBACLD,SAAS;wBACPE,QAAQC,IAAI,CACV;oBAEJ;gBACF;YACF;YAEA,wEAAwE;YACxE,MAAMX,uBAAuBC,eAAI,CAACC,UAAU,CAACtC,MAAMI,IAAI,IACnDJ,MAAMI,IAAI,GACViC,eAAI,CAACE,IAAI,CAACtD,QAAQuD,MAAM,EAAExC,MAAMI,IAAI;YACxC,IAAI;oBAIG4C;gBAHLlE,MAAM,CAAC,wBAAwB,EAAEsD,sBAAsB;gBACvD,MAAMY,mBAAoB,MAAM/D,QAAQwD,cAAc,CAACL;gBAEvD,KAAKY,sCAAAA,iBAAiBC,iBAAiB,qBAAnC,AAACD,oCAA2DE,OAAO,EAAE;wBAClCF;oBAArCG,IAAAA,4CAAoC,GAACH,uCAAAA,iBAAiBC,iBAAiB,qBAAlCD,qCAAoCE,OAAO;gBAClF;gBAEA,OAAOF;YACT,EAAE,OAAO1B,OAAY;gBACnB,OAAO,IAAIC,SACT,gCAAgCa,uBAAuB,SAASd,MAAMO,OAAO,EAC7E;oBACEH,QAAQ;oBACRC,SAAS;wBACP,gBAAgB;oBAClB;gBACF;YAEJ;QACF;QACA,MAAMyB,eAAcxC,OAAO,EAAEZ,KAAK;YAChC,MAAMqD,WAAW,MAAMpE,QAAQqE,kBAAkB,CAACtD,OAAO,IAAIoB,CAAAA,UAAe,kBAAC,CAACR;YAC9E,OAAOyC,YAAY,IAAI9B,SAAS,MAAM;gBAAEG,QAAQ;YAAI;QACtD;IACF;AAEJ"}