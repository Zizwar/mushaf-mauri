{"version":3,"sources":["../../../../../src/start/server/middleware/CreateFileMiddleware.ts"],"sourcesContent":["/**\n * Copyright Â© 2022 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport fs from 'fs';\nimport path from 'path';\n\nimport { ExpoMiddleware } from './ExpoMiddleware';\nimport { ServerRequest, ServerResponse } from './server.types';\n\nconst debug = require('debug')('expo:start:server:middleware:createFile') as typeof console.log;\n\ninterface TouchFileInput {\n  type: 'router_index';\n}\n\ninterface TouchFileOutput {\n  absolutePath: string;\n  contents: string;\n}\n\nconst ROUTER_INDEX_CONTENTS = `import { StyleSheet, Text, View } from \"react-native\";\n\nexport default function Page() {\n  return (\n    <View style={styles.container}>\n      <View style={styles.main}>\n        <Text style={styles.title}>Hello World</Text>\n        <Text style={styles.subtitle}>This is the first page of your app.</Text>\n      </View>\n    </View>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    alignItems: \"center\",\n    padding: 24,\n  },\n  main: {\n    flex: 1,\n    justifyContent: \"center\",\n    maxWidth: 960,\n    marginHorizontal: \"auto\",\n  },\n  title: {\n    fontSize: 64,\n    fontWeight: \"bold\",\n  },\n  subtitle: {\n    fontSize: 36,\n    color: \"#38434D\",\n  },\n});\n`;\n\ninterface CreateFileMiddlewareOptions {\n  /** The absolute metro or server root, used to calculate the relative dom entry path */\n  metroRoot: string;\n  /** The absolute project root, used to resolve the `expo/dom/entry.js` path */\n  projectRoot: string;\n  /** The expo-router root */\n  appDir: string;\n}\n\n/**\n * Middleware for creating a file given a `POST` request with\n * `{ contents: string, path: string }` in the body.\n */\nexport class CreateFileMiddleware extends ExpoMiddleware {\n  constructor(protected options: CreateFileMiddlewareOptions) {\n    super(options.projectRoot, ['/_expo/touch']);\n  }\n\n  protected resolveExtension(basePath: string, relativePath: string): string {\n    let resolvedPath = relativePath;\n    const extension = path.extname(relativePath);\n    if (extension === '.js') {\n      // Automatically convert JS files to TS files when added to a project\n      // with TypeScript.\n      const tsconfigPath = path.join(this.projectRoot, 'tsconfig.json');\n      if (fs.existsSync(tsconfigPath)) {\n        resolvedPath = resolvedPath.replace(/\\.js$/, '.tsx');\n      }\n    }\n    return path.join(basePath, resolvedPath);\n  }\n\n  protected async parseRawBody(req: ServerRequest): Promise<TouchFileInput> {\n    const rawBody = await new Promise<string>((resolve, reject) => {\n      let body = '';\n      req.on('data', (chunk) => {\n        body += chunk.toString();\n      });\n      req.on('end', () => {\n        resolve(body);\n      });\n      req.on('error', (err) => {\n        reject(err);\n      });\n    });\n\n    const body = JSON.parse(rawBody);\n    if (typeof body !== 'object' || body == null) {\n      throw new Error('Expected object');\n    } else if (typeof body.type !== 'string') {\n      throw new Error('Expected \"type\" in body to be string');\n    }\n\n    switch (body.type) {\n      case 'router_index':\n        return body;\n      default:\n        throw new Error('Unknown \"type\" passed in body');\n    }\n  }\n\n  private makeOutputForInput(input: TouchFileInput): TouchFileOutput {\n    switch (input.type) {\n      case 'router_index':\n        return {\n          absolutePath: this.resolveExtension(this.options.appDir, 'index.js'),\n          contents: ROUTER_INDEX_CONTENTS,\n        };\n    }\n  }\n\n  async handleRequestAsync(req: ServerRequest, res: ServerResponse): Promise<void> {\n    if (req.method !== 'POST') {\n      res.statusCode = 405;\n      res.end('Method Not Allowed');\n      return;\n    }\n\n    let properties: TouchFileInput;\n    try {\n      properties = await this.parseRawBody(req);\n    } catch (e) {\n      debug('Error parsing request body', e);\n      res.statusCode = 400;\n      res.end('Bad Request');\n      return;\n    }\n\n    debug(`Requested: %O`, properties);\n\n    const file = this.makeOutputForInput(properties);\n    if (fs.existsSync(file.absolutePath)) {\n      res.statusCode = 409;\n      res.end('File already exists.');\n      return;\n    }\n\n    debug(`Resolved path:`, file.absolutePath);\n\n    try {\n      await fs.promises.mkdir(path.dirname(file.absolutePath), { recursive: true });\n      await fs.promises.writeFile(file.absolutePath, file.contents, 'utf8');\n    } catch (e) {\n      debug('Error writing file', e);\n      res.statusCode = 500;\n      res.end('Error writing file.');\n      return;\n    }\n\n    debug(`File created`);\n    res.statusCode = 200;\n    res.end('OK');\n  }\n}\n"],"names":["CreateFileMiddleware","debug","require","ROUTER_INDEX_CONTENTS","ExpoMiddleware","constructor","options","projectRoot","resolveExtension","basePath","relativePath","resolvedPath","extension","path","extname","tsconfigPath","join","fs","existsSync","replace","parseRawBody","req","rawBody","Promise","resolve","reject","body","on","chunk","toString","err","JSON","parse","Error","type","makeOutputForInput","input","absolutePath","appDir","contents","handleRequestAsync","res","method","statusCode","end","properties","e","file","promises","mkdir","dirname","recursive","writeFile"],"mappings":"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"}