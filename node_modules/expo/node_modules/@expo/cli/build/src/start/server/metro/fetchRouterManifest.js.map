{"version":3,"sources":["../../../../../src/start/server/metro/fetchRouterManifest.ts"],"sourcesContent":["/**\n * Copyright Â© 2022 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport type { Options as RoutesManifestOptions } from '@expo/router-server/build/routes-manifest';\nimport { type RoutesManifest } from 'expo-server/private';\n\nimport { getRoutePaths } from './router';\n\nfunction getExpoRouteManifestBuilderAsync(projectRoot: string) {\n  return require('@expo/router-server/build/routes-manifest')\n    .createRoutesManifest as typeof import('@expo/router-server/build/routes-manifest').createRoutesManifest;\n}\n\ninterface FetchManifestOptions extends RoutesManifestOptions {\n  asJson?: boolean;\n  appDir: string;\n}\n\n// TODO: Simplify this now that we use Node.js directly, no need for the Metro bundler caching layer.\nasync function fetchManifest(\n  projectRoot: string,\n  options: FetchManifestOptions & { asJson: true }\n): Promise<RoutesManifest<string> | null>;\nasync function fetchManifest(\n  projectRoot: string,\n  options: FetchManifestOptions & { asJson?: false | undefined }\n): Promise<RoutesManifest<RegExp> | null>;\nasync function fetchManifest(\n  projectRoot: string,\n  options: FetchManifestOptions\n): Promise<RoutesManifest | null> {\n  const getManifest = getExpoRouteManifestBuilderAsync(projectRoot);\n  const paths = getRoutePaths(options.appDir);\n  // Get the serialized manifest\n  const jsonManifest = getManifest(paths, options);\n  if (!jsonManifest) {\n    return null;\n  }\n\n  if (!jsonManifest.htmlRoutes || !jsonManifest.apiRoutes) {\n    throw new Error('Routes manifest is malformed: ' + JSON.stringify(jsonManifest, null, 2));\n  }\n\n  if (!options.asJson) {\n    return inflateManifest(jsonManifest);\n  } else {\n    return jsonManifest;\n  }\n}\n\nexport { fetchManifest };\n\n// Convert the serialized manifest to a usable format\nexport function inflateManifest(json: RoutesManifest<string>): RoutesManifest<RegExp> {\n  return {\n    ...json,\n    middleware: json.middleware,\n    htmlRoutes: json.htmlRoutes?.map((value) => {\n      return {\n        ...value,\n        namedRegex: new RegExp(value.namedRegex),\n      };\n    }),\n    apiRoutes: json.apiRoutes?.map((value) => {\n      return {\n        ...value,\n        namedRegex: new RegExp(value.namedRegex),\n      };\n    }),\n    notFoundRoutes: json.notFoundRoutes?.map((value) => {\n      return {\n        ...value,\n        namedRegex: new RegExp(value.namedRegex),\n      };\n    }),\n    redirects: json.redirects?.map((value: any) => {\n      return {\n        ...value,\n        namedRegex: new RegExp(value.namedRegex),\n      };\n    }),\n    rewrites: json.rewrites?.map((value: any) => {\n      return {\n        ...value,\n        namedRegex: new RegExp(value.namedRegex),\n      };\n    }),\n  };\n}\n"],"names":["fetchManifest","inflateManifest","getExpoRouteManifestBuilderAsync","projectRoot","require","createRoutesManifest","options","getManifest","paths","getRoutePaths","appDir","jsonManifest","htmlRoutes","apiRoutes","Error","JSON","stringify","asJson","json","middleware","map","value","namedRegex","RegExp","notFoundRoutes","redirects","rewrites"],"mappings":"AAAA;;;;;CAKC;;;;;;;;;;;IAgDQA,aAAa;eAAbA;;IAGOC,eAAe;eAAfA;;;wBA/Cc;AAE9B,SAASC,iCAAiCC,WAAmB;IAC3D,OAAOC,QAAQ,6CACZC,oBAAoB;AACzB;AAgBA,eAAeL,cACbG,WAAmB,EACnBG,OAA6B;IAE7B,MAAMC,cAAcL,iCAAiCC;IACrD,MAAMK,QAAQC,IAAAA,qBAAa,EAACH,QAAQI,MAAM;IAC1C,8BAA8B;IAC9B,MAAMC,eAAeJ,YAAYC,OAAOF;IACxC,IAAI,CAACK,cAAc;QACjB,OAAO;IACT;IAEA,IAAI,CAACA,aAAaC,UAAU,IAAI,CAACD,aAAaE,SAAS,EAAE;QACvD,MAAM,IAAIC,MAAM,mCAAmCC,KAAKC,SAAS,CAACL,cAAc,MAAM;IACxF;IAEA,IAAI,CAACL,QAAQW,MAAM,EAAE;QACnB,OAAOhB,gBAAgBU;IACzB,OAAO;QACL,OAAOA;IACT;AACF;AAKO,SAASV,gBAAgBiB,IAA4B;QAI5CA,kBAMDA,iBAMKA,sBAMLA,iBAMDA;IA3BZ,OAAO;QACL,GAAGA,IAAI;QACPC,YAAYD,KAAKC,UAAU;QAC3BP,UAAU,GAAEM,mBAAAA,KAAKN,UAAU,qBAAfM,iBAAiBE,GAAG,CAAC,CAACC;YAChC,OAAO;gBACL,GAAGA,KAAK;gBACRC,YAAY,IAAIC,OAAOF,MAAMC,UAAU;YACzC;QACF;QACAT,SAAS,GAAEK,kBAAAA,KAAKL,SAAS,qBAAdK,gBAAgBE,GAAG,CAAC,CAACC;YAC9B,OAAO;gBACL,GAAGA,KAAK;gBACRC,YAAY,IAAIC,OAAOF,MAAMC,UAAU;YACzC;QACF;QACAE,cAAc,GAAEN,uBAAAA,KAAKM,cAAc,qBAAnBN,qBAAqBE,GAAG,CAAC,CAACC;YACxC,OAAO;gBACL,GAAGA,KAAK;gBACRC,YAAY,IAAIC,OAAOF,MAAMC,UAAU;YACzC;QACF;QACAG,SAAS,GAAEP,kBAAAA,KAAKO,SAAS,qBAAdP,gBAAgBE,GAAG,CAAC,CAACC;YAC9B,OAAO;gBACL,GAAGA,KAAK;gBACRC,YAAY,IAAIC,OAAOF,MAAMC,UAAU;YACzC;QACF;QACAI,QAAQ,GAAER,iBAAAA,KAAKQ,QAAQ,qBAAbR,eAAeE,GAAG,CAAC,CAACC;YAC5B,OAAO;gBACL,GAAGA,KAAK;gBACRC,YAAY,IAAIC,OAAOF,MAAMC,UAAU;YACzC;QACF;IACF;AACF"}