{"version":3,"sources":["../../../../src/start/server/MCPDevToolsPluginCLIExtensions.ts"],"sourcesContent":["import { DevServerManager } from './DevServerManager';\nimport { DevToolsPluginOutputSchema } from './DevToolsPlugin.schema';\nimport { DevToolsPluginCliExtensionExecutor } from './DevToolsPluginCliExtensionExecutor';\nimport { McpServer } from './MCP';\nimport { createMCPDevToolsExtensionSchema } from './createMCPDevToolsExtensionSchema';\nimport { Log } from '../../log';\n\nconst debug = require('debug')('expo:start:server:devtools:mcp');\n\nexport async function addMcpCapabilities(mcpServer: McpServer, devServerManager: DevServerManager) {\n  const plugins = await devServerManager.devtoolsPluginManager.queryPluginsAsync();\n\n  for (const plugin of plugins) {\n    if (plugin.cliExtensions) {\n      const commands = (plugin.cliExtensions.commands ?? []).filter((p) =>\n        p.environments?.includes('mcp')\n      );\n      if (commands.length === 0) {\n        continue;\n      }\n\n      const schema = createMCPDevToolsExtensionSchema(plugin);\n\n      debug(\n        `Installing MCP CLI extension for plugin: ${plugin.packageName} - found ${commands.length} commands`\n      );\n\n      mcpServer.registerTool(\n        plugin.packageName,\n        {\n          title: plugin.packageName,\n          description: plugin.description,\n          inputSchema: { parameters: schema },\n        },\n        async ({ parameters }) => {\n          try {\n            const { command, ...args } = parameters;\n\n            const metroServerOrigin = devServerManager\n              .getDefaultDevServer()\n              .getJsInspectorBaseUrl();\n\n            const results = await new DevToolsPluginCliExtensionExecutor(\n              plugin,\n              devServerManager.projectRoot\n            ).execute({ command, args, metroServerOrigin });\n\n            const parsedResults = DevToolsPluginOutputSchema.safeParse(results);\n            if (parsedResults.success === false) {\n              throw new Error(\n                `Invalid output from CLI command: ${parsedResults.error.issues\n                  .map((issue) => issue.message)\n                  .join(', ')}`\n              );\n            }\n            return {\n              content: parsedResults.data\n                .map((line) => {\n                  const { type } = line;\n                  if (type === 'text') {\n                    return { type, text: line.text, level: line.level, url: line.url };\n                  } else if (line.type === 'image' || line.type === 'audio') {\n                    // We could present this as a resource_link, but it seems not to be well supported in MCP clients,\n                    // so we'll return a text with the link instead.\n                    return {\n                      type: 'text',\n                      text: `${type} resource: ${line.url}${line.text ? ' (' + line.text + ')' : ''}`,\n                    } as const;\n                  }\n                  return null;\n                })\n                .filter((line): line is Exclude<typeof line, null> => line !== null),\n            };\n          } catch (e: any) {\n            Log.error('Error executing MCP CLI command:', e);\n            return {\n              content: [{ type: 'text', text: `Error executing command: ${e.toString()}` }],\n              isError: true,\n            };\n          }\n        }\n      );\n    }\n  }\n}\n"],"names":["addMcpCapabilities","debug","require","mcpServer","devServerManager","plugins","devtoolsPluginManager","queryPluginsAsync","plugin","cliExtensions","commands","filter","p","environments","includes","length","schema","createMCPDevToolsExtensionSchema","packageName","registerTool","title","description","inputSchema","parameters","command","args","metroServerOrigin","getDefaultDevServer","getJsInspectorBaseUrl","results","DevToolsPluginCliExtensionExecutor","projectRoot","execute","parsedResults","DevToolsPluginOutputSchema","safeParse","success","Error","error","issues","map","issue","message","join","content","data","line","type","text","level","url","e","Log","toString","isError"],"mappings":";;;;+BASsBA;;;eAAAA;;;sCARqB;oDACQ;kDAEF;qBAC7B;AAEpB,MAAMC,QAAQC,QAAQ,SAAS;AAExB,eAAeF,mBAAmBG,SAAoB,EAAEC,gBAAkC;IAC/F,MAAMC,UAAU,MAAMD,iBAAiBE,qBAAqB,CAACC,iBAAiB;IAE9E,KAAK,MAAMC,UAAUH,QAAS;QAC5B,IAAIG,OAAOC,aAAa,EAAE;YACxB,MAAMC,WAAW,AAACF,CAAAA,OAAOC,aAAa,CAACC,QAAQ,IAAI,EAAE,AAAD,EAAGC,MAAM,CAAC,CAACC;oBAC7DA;wBAAAA,kBAAAA,EAAEC,YAAY,qBAAdD,gBAAgBE,QAAQ,CAAC;;YAE3B,IAAIJ,SAASK,MAAM,KAAK,GAAG;gBACzB;YACF;YAEA,MAAMC,SAASC,IAAAA,kEAAgC,EAACT;YAEhDP,MACE,CAAC,yCAAyC,EAAEO,OAAOU,WAAW,CAAC,SAAS,EAAER,SAASK,MAAM,CAAC,SAAS,CAAC;YAGtGZ,UAAUgB,YAAY,CACpBX,OAAOU,WAAW,EAClB;gBACEE,OAAOZ,OAAOU,WAAW;gBACzBG,aAAab,OAAOa,WAAW;gBAC/BC,aAAa;oBAAEC,YAAYP;gBAAO;YACpC,GACA,OAAO,EAAEO,UAAU,EAAE;gBACnB,IAAI;oBACF,MAAM,EAAEC,OAAO,EAAE,GAAGC,MAAM,GAAGF;oBAE7B,MAAMG,oBAAoBtB,iBACvBuB,mBAAmB,GACnBC,qBAAqB;oBAExB,MAAMC,UAAU,MAAM,IAAIC,sEAAkC,CAC1DtB,QACAJ,iBAAiB2B,WAAW,EAC5BC,OAAO,CAAC;wBAAER;wBAASC;wBAAMC;oBAAkB;oBAE7C,MAAMO,gBAAgBC,gDAA0B,CAACC,SAAS,CAACN;oBAC3D,IAAII,cAAcG,OAAO,KAAK,OAAO;wBACnC,MAAM,IAAIC,MACR,CAAC,iCAAiC,EAAEJ,cAAcK,KAAK,CAACC,MAAM,CAC3DC,GAAG,CAAC,CAACC,QAAUA,MAAMC,OAAO,EAC5BC,IAAI,CAAC,OAAO;oBAEnB;oBACA,OAAO;wBACLC,SAASX,cAAcY,IAAI,CACxBL,GAAG,CAAC,CAACM;4BACJ,MAAM,EAAEC,IAAI,EAAE,GAAGD;4BACjB,IAAIC,SAAS,QAAQ;gCACnB,OAAO;oCAAEA;oCAAMC,MAAMF,KAAKE,IAAI;oCAAEC,OAAOH,KAAKG,KAAK;oCAAEC,KAAKJ,KAAKI,GAAG;gCAAC;4BACnE,OAAO,IAAIJ,KAAKC,IAAI,KAAK,WAAWD,KAAKC,IAAI,KAAK,SAAS;gCACzD,kGAAkG;gCAClG,gDAAgD;gCAChD,OAAO;oCACLA,MAAM;oCACNC,MAAM,GAAGD,KAAK,WAAW,EAAED,KAAKI,GAAG,GAAGJ,KAAKE,IAAI,GAAG,OAAOF,KAAKE,IAAI,GAAG,MAAM,IAAI;gCACjF;4BACF;4BACA,OAAO;wBACT,GACCrC,MAAM,CAAC,CAACmC,OAA6CA,SAAS;oBACnE;gBACF,EAAE,OAAOK,GAAQ;oBACfC,QAAG,CAACd,KAAK,CAAC,oCAAoCa;oBAC9C,OAAO;wBACLP,SAAS;4BAAC;gCAAEG,MAAM;gCAAQC,MAAM,CAAC,yBAAyB,EAAEG,EAAEE,QAAQ,IAAI;4BAAC;yBAAE;wBAC7EC,SAAS;oBACX;gBACF;YACF;QAEJ;IACF;AACF"}