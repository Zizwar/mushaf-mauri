{"version":3,"sources":["../../../../src/start/server/MCP.ts"],"sourcesContent":["import type {\n  McpServerProxy,\n  TunnelMcpServerProxy as TunnelMcpServerProxyType,\n} from '@expo/mcp-tunnel' with { 'resolution-mode': 'import' };\nimport path from 'node:path';\nimport resolveFrom from 'resolve-from';\n\nimport { getAccessToken, getSession } from '../../api/user/UserSettings';\nimport { Log } from '../../log';\nimport { env } from '../../utils/env';\nimport { installExitHooks } from '../../utils/exit';\n\nconst importESM = require('@expo/cli/add-module') as <T>(moduleName: string) => Promise<T>;\n\nconst debug = require('debug')('expo:start:server:mcp') as typeof console.log;\n\n/**\n * The MCP server\n */\nexport type McpServer = Omit<McpServerProxy, 'close'> & {\n  /**\n   * Close the server\n   */\n  closeAsync: () => Promise<void>;\n};\n\n/**\n * Create the MCP server\n */\nexport async function maybeCreateMCPServerAsync({\n  projectRoot,\n  devServerUrl,\n}: {\n  projectRoot: string;\n  devServerUrl: string;\n}): Promise<McpServer | null> {\n  const mcpServer = env.EXPO_UNSTABLE_MCP_SERVER;\n  if (!mcpServer) {\n    return null;\n  }\n  const mcpPackagePath = resolveFrom.silent(projectRoot, 'expo-mcp');\n  if (!mcpPackagePath) {\n    Log.error(\n      'Missing the `expo-mcp` package in the project. To enable the MCP integration, add the `expo-mcp` package to your project.'\n    );\n    return null;\n  }\n  const mcpTunnelPackagePath = resolveFrom.silent(path.dirname(mcpPackagePath), '@expo/mcp-tunnel');\n  if (!mcpTunnelPackagePath) {\n    Log.error('Unable to resolve the `@expo/mcp-tunnel` package');\n    return null;\n  }\n\n  const normalizedServer = /^([a-zA-Z][a-zA-Z\\d+\\-.]*):\\/\\//.test(mcpServer)\n    ? mcpServer\n    : `wss://${mcpServer}`;\n  const mcpServerUrlObject = new URL(normalizedServer);\n  const scheme = mcpServerUrlObject.protocol ?? 'wss:';\n  const mcpServerUrl = `${scheme}//${mcpServerUrlObject.host}`;\n  debug(`Creating MCP tunnel - server URL: ${mcpServerUrl}`);\n\n  try {\n    const { addMcpCapabilities } = await importESM<{\n      addMcpCapabilities: (server: McpServerProxy, projectRoot: string) => void;\n    }>(mcpPackagePath);\n    const { TunnelMcpServerProxy } = await importESM<{\n      TunnelMcpServerProxy: typeof TunnelMcpServerProxyType;\n    }>(mcpTunnelPackagePath);\n\n    const logger = {\n      ...Log,\n      debug(...message: any[]): void {\n        debug(...message);\n      },\n      info(...message: any[]): void {\n        Log.log(...message);\n      },\n    };\n    const serverProxy: McpServerProxy = new TunnelMcpServerProxy(mcpServerUrl, {\n      logger,\n      wsHeaders: createAuthHeaders(),\n      projectRoot,\n      devServerUrl,\n    });\n    addMcpCapabilities(serverProxy, projectRoot);\n\n    const removeExitHook = installExitHooks(async () => {\n      await serverProxy.close();\n    });\n    const server = serverProxy as unknown as McpServer;\n    server.closeAsync = async () => {\n      removeExitHook();\n      await serverProxy.close();\n    };\n\n    return server;\n  } catch (error: unknown) {\n    debug(`Error creating MCP tunnel: ${error}`);\n  }\n  return null;\n}\n\nfunction createAuthHeaders(): Record<string, string> {\n  const token = getAccessToken();\n  if (token) {\n    return {\n      authorization: `Bearer ${token}`,\n    };\n  }\n  const sessionSecret = getSession()?.sessionSecret;\n  if (sessionSecret) {\n    return {\n      'expo-session': sessionSecret,\n    };\n  }\n  return {};\n}\n"],"names":["maybeCreateMCPServerAsync","importESM","require","debug","projectRoot","devServerUrl","mcpServer","env","EXPO_UNSTABLE_MCP_SERVER","mcpPackagePath","resolveFrom","silent","Log","error","mcpTunnelPackagePath","path","dirname","normalizedServer","test","mcpServerUrlObject","URL","scheme","protocol","mcpServerUrl","host","addMcpCapabilities","TunnelMcpServerProxy","logger","message","info","log","serverProxy","wsHeaders","createAuthHeaders","removeExitHook","installExitHooks","close","server","closeAsync","getSession","token","getAccessToken","authorization","sessionSecret"],"mappings":";;;;+BA6BsBA;;;eAAAA;;;;gEAzBL;;;;;;;gEACO;;;;;;8BAEmB;qBACvB;qBACA;sBACa;;;;;;AAEjC,MAAMC,YAAYC,QAAQ;AAE1B,MAAMC,QAAQD,QAAQ,SAAS;AAexB,eAAeF,0BAA0B,EAC9CI,WAAW,EACXC,YAAY,EAIb;IACC,MAAMC,YAAYC,QAAG,CAACC,wBAAwB;IAC9C,IAAI,CAACF,WAAW;QACd,OAAO;IACT;IACA,MAAMG,iBAAiBC,sBAAW,CAACC,MAAM,CAACP,aAAa;IACvD,IAAI,CAACK,gBAAgB;QACnBG,QAAG,CAACC,KAAK,CACP;QAEF,OAAO;IACT;IACA,MAAMC,uBAAuBJ,sBAAW,CAACC,MAAM,CAACI,mBAAI,CAACC,OAAO,CAACP,iBAAiB;IAC9E,IAAI,CAACK,sBAAsB;QACzBF,QAAG,CAACC,KAAK,CAAC;QACV,OAAO;IACT;IAEA,MAAMI,mBAAmB,kCAAkCC,IAAI,CAACZ,aAC5DA,YACA,CAAC,MAAM,EAAEA,WAAW;IACxB,MAAMa,qBAAqB,IAAIC,IAAIH;IACnC,MAAMI,SAASF,mBAAmBG,QAAQ,IAAI;IAC9C,MAAMC,eAAe,GAAGF,OAAO,EAAE,EAAEF,mBAAmBK,IAAI,EAAE;IAC5DrB,MAAM,CAAC,kCAAkC,EAAEoB,cAAc;IAEzD,IAAI;QACF,MAAM,EAAEE,kBAAkB,EAAE,GAAG,MAAMxB,UAElCQ;QACH,MAAM,EAAEiB,oBAAoB,EAAE,GAAG,MAAMzB,UAEpCa;QAEH,MAAMa,SAAS;YACb,GAAGf,QAAG;YACNT,OAAM,GAAGyB,OAAc;gBACrBzB,SAASyB;YACX;YACAC,MAAK,GAAGD,OAAc;gBACpBhB,QAAG,CAACkB,GAAG,IAAIF;YACb;QACF;QACA,MAAMG,cAA8B,IAAIL,qBAAqBH,cAAc;YACzEI;YACAK,WAAWC;YACX7B;YACAC;QACF;QACAoB,mBAAmBM,aAAa3B;QAEhC,MAAM8B,iBAAiBC,IAAAA,sBAAgB,EAAC;YACtC,MAAMJ,YAAYK,KAAK;QACzB;QACA,MAAMC,SAASN;QACfM,OAAOC,UAAU,GAAG;YAClBJ;YACA,MAAMH,YAAYK,KAAK;QACzB;QAEA,OAAOC;IACT,EAAE,OAAOxB,OAAgB;QACvBV,MAAM,CAAC,2BAA2B,EAAEU,OAAO;IAC7C;IACA,OAAO;AACT;AAEA,SAASoB;QAOeM;IANtB,MAAMC,QAAQC,IAAAA,4BAAc;IAC5B,IAAID,OAAO;QACT,OAAO;YACLE,eAAe,CAAC,OAAO,EAAEF,OAAO;QAClC;IACF;IACA,MAAMG,iBAAgBJ,cAAAA,IAAAA,wBAAU,wBAAVA,YAAcI,aAAa;IACjD,IAAIA,eAAe;QACjB,OAAO;YACL,gBAAgBA;QAClB;IACF;IACA,OAAO,CAAC;AACV"}