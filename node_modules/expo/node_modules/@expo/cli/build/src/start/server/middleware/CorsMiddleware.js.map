{"version":3,"sources":["../../../../../src/start/server/middleware/CorsMiddleware.ts"],"sourcesContent":["import type { ExpoConfig } from '@expo/config';\n\nimport type { ServerRequest, ServerResponse } from './server.types';\n\nconst DEFAULT_ALLOWED_CORS_HOSTS = [\n  'devtools', // Support local Chrome DevTools `devtools://devtools`\n];\n\n/** Check if hostname matches \"localhost\" exactly, the local IPv6,\n * a local IPV4 in the 127.0.0.0/8 range, or an IPv6-to-4 range\n * (starting with ::ffff: and ending in an IPv4) */\nexport const _isLocalHostname = (hostname: string) => {\n  if (hostname === 'localhost') {\n    return true;\n  }\n  let maybeIp = hostname;\n  const ipv6To4Prefix = '::ffff:';\n  if (maybeIp.startsWith(ipv6To4Prefix)) {\n    maybeIp = maybeIp.slice(ipv6To4Prefix.length);\n  }\n  if (maybeIp === '::1') {\n    return true;\n  } else if (/^127(?:.\\d+){3}$/.test(maybeIp)) {\n    return maybeIp.split('.').every((part) => {\n      const num = parseInt(part, 10);\n      return num >= 0 && num <= 255;\n    });\n  } else {\n    return false;\n  }\n};\n\nexport function createCorsMiddleware(exp: ExpoConfig) {\n  const allowedHosts = [...DEFAULT_ALLOWED_CORS_HOSTS];\n  // Support for expo-router API routes\n  if (exp.extra?.router?.headOrigin) {\n    allowedHosts.push(new URL(exp.extra.router.headOrigin).host);\n  }\n  if (exp.extra?.router?.origin) {\n    allowedHosts.push(new URL(exp.extra.router.origin).host);\n  }\n\n  return (req: ServerRequest, res: ServerResponse, next: (err?: Error) => void) => {\n    if (typeof req.headers.origin === 'string') {\n      const { host, hostname } = new URL(req.headers.origin);\n      const isSameOrigin = host === req.headers.host;\n      const isLocalhost = _isLocalHostname(hostname);\n      const isAllowedHost = allowedHosts.includes(host) || isLocalhost;\n      if (!isSameOrigin && !isAllowedHost) {\n        next(\n          new Error(\n            `Unauthorized request from ${req.headers.origin}. ` +\n              'This may happen because of a conflicting browser extension to intercept HTTP requests. ' +\n              'Disable browser extensions or use incognito mode and try again.'\n          )\n        );\n        return;\n      } else if (!isLocalhost && isAllowedHost) {\n        // Skipped for localhost to only allow requests from this dev-sever and not escalate\n        // the cross-origin resource sharing that's allowed beyond the browser's defaults\n        res.setHeader('Access-Control-Allow-Origin', req.headers.origin);\n      }\n\n      maybePreventMetroResetCorsHeader(req, res);\n    }\n\n    // Block MIME-type sniffing.\n    res.setHeader('X-Content-Type-Options', 'nosniff');\n\n    next();\n  };\n}\n\n// When accessing source maps,\n// metro will overwrite the `Access-Control-Allow-Origin` header with hardcoded `devtools://devtools` value.\n// https://github.com/facebook/metro/blob/a7f8955e6d2424b0d5f73d4bcdaf22560e1d5f27/packages/metro/src/Server.js#L540\n// This is a workaround to prevent this behavior.\nfunction maybePreventMetroResetCorsHeader(req: ServerRequest, res: ServerResponse) {\n  const pathname = req.url ? new URL(req.url, `http://${req.headers.host}`).pathname : '';\n  if (pathname.endsWith('.map')) {\n    const setHeader = res.setHeader.bind(res);\n    res.setHeader = (key, ...args) => {\n      if (key !== 'Access-Control-Allow-Origin') {\n        setHeader(key, ...args);\n      }\n      return res;\n    };\n  }\n}\n"],"names":["_isLocalHostname","createCorsMiddleware","DEFAULT_ALLOWED_CORS_HOSTS","hostname","maybeIp","ipv6To4Prefix","startsWith","slice","length","test","split","every","part","num","parseInt","exp","allowedHosts","extra","router","headOrigin","push","URL","host","origin","req","res","next","headers","isSameOrigin","isLocalhost","isAllowedHost","includes","Error","setHeader","maybePreventMetroResetCorsHeader","pathname","url","endsWith","bind","key","args"],"mappings":";;;;;;;;;;;IAWaA,gBAAgB;eAAhBA;;IAqBGC,oBAAoB;eAApBA;;;AA5BhB,MAAMC,6BAA6B;IACjC;CACD;AAKM,MAAMF,mBAAmB,CAACG;IAC/B,IAAIA,aAAa,aAAa;QAC5B,OAAO;IACT;IACA,IAAIC,UAAUD;IACd,MAAME,gBAAgB;IACtB,IAAID,QAAQE,UAAU,CAACD,gBAAgB;QACrCD,UAAUA,QAAQG,KAAK,CAACF,cAAcG,MAAM;IAC9C;IACA,IAAIJ,YAAY,OAAO;QACrB,OAAO;IACT,OAAO,IAAI,mBAAmBK,IAAI,CAACL,UAAU;QAC3C,OAAOA,QAAQM,KAAK,CAAC,KAAKC,KAAK,CAAC,CAACC;YAC/B,MAAMC,MAAMC,SAASF,MAAM;YAC3B,OAAOC,OAAO,KAAKA,OAAO;QAC5B;IACF,OAAO;QACL,OAAO;IACT;AACF;AAEO,SAASZ,qBAAqBc,GAAe;QAG9CA,mBAAAA,YAGAA,oBAAAA;IALJ,MAAMC,eAAe;WAAId;KAA2B;IACpD,qCAAqC;IACrC,KAAIa,aAAAA,IAAIE,KAAK,sBAATF,oBAAAA,WAAWG,MAAM,qBAAjBH,kBAAmBI,UAAU,EAAE;QACjCH,aAAaI,IAAI,CAAC,IAAIC,IAAIN,IAAIE,KAAK,CAACC,MAAM,CAACC,UAAU,EAAEG,IAAI;IAC7D;IACA,KAAIP,cAAAA,IAAIE,KAAK,sBAATF,qBAAAA,YAAWG,MAAM,qBAAjBH,mBAAmBQ,MAAM,EAAE;QAC7BP,aAAaI,IAAI,CAAC,IAAIC,IAAIN,IAAIE,KAAK,CAACC,MAAM,CAACK,MAAM,EAAED,IAAI;IACzD;IAEA,OAAO,CAACE,KAAoBC,KAAqBC;QAC/C,IAAI,OAAOF,IAAIG,OAAO,CAACJ,MAAM,KAAK,UAAU;YAC1C,MAAM,EAAED,IAAI,EAAEnB,QAAQ,EAAE,GAAG,IAAIkB,IAAIG,IAAIG,OAAO,CAACJ,MAAM;YACrD,MAAMK,eAAeN,SAASE,IAAIG,OAAO,CAACL,IAAI;YAC9C,MAAMO,cAAc7B,iBAAiBG;YACrC,MAAM2B,gBAAgBd,aAAae,QAAQ,CAACT,SAASO;YACrD,IAAI,CAACD,gBAAgB,CAACE,eAAe;gBACnCJ,KACE,IAAIM,MACF,CAAC,0BAA0B,EAAER,IAAIG,OAAO,CAACJ,MAAM,CAAC,EAAE,CAAC,GACjD,4FACA;gBAGN;YACF,OAAO,IAAI,CAACM,eAAeC,eAAe;gBACxC,oFAAoF;gBACpF,iFAAiF;gBACjFL,IAAIQ,SAAS,CAAC,+BAA+BT,IAAIG,OAAO,CAACJ,MAAM;YACjE;YAEAW,iCAAiCV,KAAKC;QACxC;QAEA,4BAA4B;QAC5BA,IAAIQ,SAAS,CAAC,0BAA0B;QAExCP;IACF;AACF;AAEA,8BAA8B;AAC9B,4GAA4G;AAC5G,oHAAoH;AACpH,iDAAiD;AACjD,SAASQ,iCAAiCV,GAAkB,EAAEC,GAAmB;IAC/E,MAAMU,WAAWX,IAAIY,GAAG,GAAG,IAAIf,IAAIG,IAAIY,GAAG,EAAE,CAAC,OAAO,EAAEZ,IAAIG,OAAO,CAACL,IAAI,EAAE,EAAEa,QAAQ,GAAG;IACrF,IAAIA,SAASE,QAAQ,CAAC,SAAS;QAC7B,MAAMJ,YAAYR,IAAIQ,SAAS,CAACK,IAAI,CAACb;QACrCA,IAAIQ,SAAS,GAAG,CAACM,KAAK,GAAGC;YACvB,IAAID,QAAQ,+BAA+B;gBACzCN,UAAUM,QAAQC;YACpB;YACA,OAAOf;QACT;IACF;AACF"}