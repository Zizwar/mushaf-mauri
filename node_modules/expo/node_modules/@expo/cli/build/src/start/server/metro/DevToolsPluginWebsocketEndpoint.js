"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "createDevToolsPluginWebsocketEndpoint", {
    enumerable: true,
    get: function() {
        return createDevToolsPluginWebsocketEndpoint;
    }
});
function _ws() {
    const data = require("ws");
    _ws = function() {
        return data;
    };
    return data;
}
const _net = require("../../../utils/net");
function createDevToolsPluginWebsocketEndpoint({ serverBaseUrl }) {
    const wss = new (_ws()).WebSocketServer({
        noServer: true
    });
    wss.on('connection', (ws, request)=>{
        // Explicitly limit devtools websocket to loopback requests
        if (request.headers.origin && !(0, _net.isMatchingOrigin)(request, serverBaseUrl)) {
            // NOTE: `socket.close` nicely closes the websocket, which will still allow incoming messages
            // `socket.terminate` instead forcefully closes down the socket
            ws.terminate();
            return;
        }
        ws.on('message', (message, isBinary)=>{
            // Broadcast the received message to all other connected clients
            wss.clients.forEach((client)=>{
                if (client !== ws && client.readyState === _ws().WebSocket.OPEN) {
                    client.send(message, {
                        binary: isBinary
                    });
                }
            });
        });
    });
    return {
        '/expo-dev-plugins/broadcast': wss
    };
}

//# sourceMappingURL=DevToolsPluginWebsocketEndpoint.js.map