{"version":3,"sources":["../../../../src/start/server/createMCPDevToolsExtensionSchema.ts"],"sourcesContent":["import { z } from 'zod';\n\nimport { DevToolsPlugin } from './DevToolsPlugin';\n\n/**\n * Creates an MCP-compatible JSON schema for a DevTools plugin's CLI extensions.\n *\n * LLM agents have varying support for complex JSON schema features like `anyOf`/`oneOf`\n * discriminated unions. This implementation uses a flat schema with an enum for the\n * command name, which provides the best compatibility across different LLM providers:\n *\n * - OpenAI: Supports `anyOf` but requires `additionalProperties: false` and all fields `required`\n * - Claude/Anthropic: Works best with simple flat schemas with enums\n * - Other providers: Generally have limited or inconsistent support for discriminated unions\n *\n * To compensate for the lack of discriminated unions, parameter descriptions include\n * which command(s) they belong to, and command descriptions include their parameters.\n *\n * The resulting schema structure is:\n * ```json\n * {\n *   \"type\": \"object\",\n *   \"properties\": {\n *     \"command\": {\n *       \"type\": \"string\",\n *       \"enum\": [\"cmd1\", \"cmd2\", ...],\n *       \"description\": \"The command to execute. Available commands: \\\"cmd1\\\" - Title 1 (params: foo); ...\"\n *     },\n *     \"foo\": { \"type\": \"string\", \"description\": \"Foo description (Used by: \\\"cmd1\\\")\" },\n *     ...\n *   },\n *   \"required\": [\"command\"],\n *   \"additionalProperties\": false\n * }\n * ```\n */\nexport function createMCPDevToolsExtensionSchema(plugin: DevToolsPlugin) {\n  if (plugin.cliExtensions == null || plugin.cliExtensions?.commands.length === 0) {\n    throw new Error(\n      `Plugin ${plugin.packageName} has no commands defined. Please define at least one command.`\n    );\n  }\n\n  const commands = plugin.cliExtensions.commands;\n\n  // Build a rich description that explains each command and its parameters\n  const commandDescriptions = commands\n    .map((c) => {\n      const params = c.parameters?.map((p) => p.name).join(', ');\n      return params ? `\"${c.name}\": ${c.title} (params: ${params})` : `\"${c.name}\": ${c.title}`;\n    })\n    .join('. ');\n\n  // Create enum of command names for clear LLM selection\n  const commandNames = commands.map((c) => c.name) as [string, ...string[]];\n\n  // Collect all unique parameters across all commands\n  // Track which commands use each parameter for documentation\n  const parameterCommandMap: Record<string, string[]> = {};\n  const parameterDescriptions: Record<string, string> = {};\n\n  for (const command of commands) {\n    if (command.parameters && command.parameters.length > 0) {\n      for (const param of command.parameters) {\n        if (!parameterCommandMap[param.name]) {\n          parameterCommandMap[param.name] = [];\n          parameterDescriptions[param.name] = param.description || '';\n        }\n        parameterCommandMap[param.name].push(command.name);\n      }\n    }\n  }\n\n  // Build parameters with descriptions that indicate which command(s) they belong to\n  const allParameters: Record<string, z.ZodTypeAny> = {};\n  for (const [paramName, commandList] of Object.entries(parameterCommandMap)) {\n    const baseDescription = parameterDescriptions[paramName];\n    const commandsUsingParam =\n      commandList.length === commands.length\n        ? 'all commands'\n        : commandList.map((c) => `\"${c}\"`).join(', ');\n\n    // Include command context in the description so LLMs know when to use each parameter\n    const fullDescription = baseDescription\n      ? `${baseDescription} (Used by: ${commandsUsingParam})`\n      : `Parameter for: ${commandsUsingParam}`;\n\n    allParameters[paramName] = z.string().optional().describe(fullDescription);\n  }\n\n  // Build the command description with clear instructions for the LLM\n  const hasParameters = Object.keys(allParameters).length > 0;\n  const commandDescription = hasParameters\n    ? `Required. The command to execute. You must select exactly one command from the enum values. ` +\n      `Each command may require specific parameters - only include parameters that belong to the selected command. ` +\n      `Commands: ${commandDescriptions}.`\n    : `Required. The command to execute. Select exactly one from the available options. ` +\n      `Commands: ${commandDescriptions}.`;\n\n  // Build the flat schema with additionalProperties: false for LLM compatibility\n  const schema = z\n    .object({\n      command: z.enum(commandNames).describe(commandDescription),\n      ...allParameters,\n    })\n    .strict(); // .strict() adds additionalProperties: false\n\n  return schema;\n}\n"],"names":["createMCPDevToolsExtensionSchema","plugin","cliExtensions","commands","length","Error","packageName","commandDescriptions","map","c","params","parameters","p","name","join","title","commandNames","parameterCommandMap","parameterDescriptions","command","param","description","push","allParameters","paramName","commandList","Object","entries","baseDescription","commandsUsingParam","fullDescription","z","string","optional","describe","hasParameters","keys","commandDescription","schema","object","enum","strict"],"mappings":"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"}