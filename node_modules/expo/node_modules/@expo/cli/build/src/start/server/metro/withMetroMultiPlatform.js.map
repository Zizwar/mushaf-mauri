{"version":3,"sources":["../../../../../src/start/server/metro/withMetroMultiPlatform.ts"],"sourcesContent":["/**\n * Copyright Â© 2022 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport type { ExpoConfig, Platform } from '@expo/config';\nimport type Bundler from '@expo/metro/metro/Bundler';\nimport type { ConfigT } from '@expo/metro/metro-config';\nimport type {\n  Resolution,\n  ResolutionContext,\n  CustomResolutionContext,\n} from '@expo/metro/metro-resolver';\nimport { resolve as resolver } from '@expo/metro/metro-resolver';\nimport type { SourceFileResolution } from '@expo/metro/metro-resolver/types';\nimport fs from 'fs';\nimport path from 'path';\nimport resolveFrom from 'resolve-from';\n\nimport {\n  createAutolinkingModuleResolverInput,\n  createAutolinkingModuleResolver,\n  AutolinkingModuleResolverInput,\n} from './createExpoAutolinkingResolver';\nimport { createFallbackModuleResolver } from './createExpoFallbackResolver';\nimport { FailedToResolveNativeOnlyModuleError } from './errors/FailedToResolveNativeOnlyModuleError';\nimport { isNodeExternal, shouldCreateVirtualShim } from './externals';\nimport { isFailedToResolveNameError, isFailedToResolvePathError } from './metroErrors';\nimport { getMetroBundlerWithVirtualModules } from './metroVirtualModules';\nimport { withMetroErrorReportingResolver } from './withMetroErrorReportingResolver';\nimport { withMetroMutatedResolverContext, withMetroResolvers } from './withMetroResolvers';\nimport { withMetroSupervisingTransformWorker } from './withMetroSupervisingTransformWorker';\nimport { Log } from '../../../log';\nimport { FileNotifier } from '../../../utils/FileNotifier';\nimport { env } from '../../../utils/env';\nimport { installExitHooks } from '../../../utils/exit';\nimport { isInteractive } from '../../../utils/interactive';\nimport { loadTsConfigPathsAsync, TsConfigPaths } from '../../../utils/tsconfig/loadTsConfigPaths';\nimport { resolveWithTsConfigPaths } from '../../../utils/tsconfig/resolveWithTsConfigPaths';\nimport { isServerEnvironment } from '../middleware/metroOptions';\nimport { PlatformBundlers } from '../platformBundlers';\n\nexport type StrictResolver = (moduleName: string) => Resolution;\nexport type StrictResolverFactory = (\n  context: ResolutionContext,\n  platform: string | null\n) => StrictResolver;\n\nconst ASSET_REGISTRY_SRC = `const assets=[];module.exports={registerAsset:s=>assets.push(s),getAssetByID:s=>assets[s-1]};`;\n\nconst debug = require('debug')('expo:start:server:metro:multi-platform') as typeof console.log;\n\nfunction asWritable<T>(input: T): { -readonly [K in keyof T]: T[K] } {\n  return input;\n}\n\nfunction withWebPolyfills(\n  config: ConfigT,\n  {\n    getMetroBundler,\n  }: {\n    getMetroBundler: () => Bundler;\n  }\n): ConfigT {\n  const originalGetPolyfills = config.serializer.getPolyfills\n    ? config.serializer.getPolyfills.bind(config.serializer)\n    : () => [];\n\n  const getPolyfills = (ctx: { platform?: string | null }): readonly string[] => {\n    const virtualEnvVarId = `\\0polyfill:environment-variables`;\n\n    getMetroBundlerWithVirtualModules(getMetroBundler()).setVirtualModule(\n      virtualEnvVarId,\n      (() => {\n        return `//`;\n      })()\n    );\n\n    const virtualModuleId = `\\0polyfill:external-require`;\n\n    getMetroBundlerWithVirtualModules(getMetroBundler()).setVirtualModule(\n      virtualModuleId,\n      (() => {\n        if (ctx.platform === 'web') {\n          // NOTE(@hassankhan): We need to wrap require in an arrow function rather than assigning\n          // it directly because `workerd` loses its `this` context when `require` is dereferenced\n          // and called later.\n          return `global.$$require_external = typeof require !== \"undefined\" ? (m) => require(m) : () => null;`;\n        } else {\n          // Wrap in try/catch to support Android.\n          return 'try { global.$$require_external = typeof expo === \"undefined\" ? require : (moduleId) => { throw new Error(`Node.js standard library module ${moduleId} is not available in this JavaScript environment`);} } catch { global.$$require_external = (moduleId) => { throw new Error(`Node.js standard library module ${moduleId} is not available in this JavaScript environment`);} }';\n        }\n      })()\n    );\n\n    const virtualModulesPolyfills = [virtualModuleId, virtualEnvVarId];\n\n    if (ctx.platform === 'web') {\n      try {\n        const rnGetPolyfills: () => string[] = require('react-native/rn-get-polyfills');\n        return [\n          ...virtualModulesPolyfills,\n          // Ensure that the error-guard polyfill is included in the web polyfills to\n          // make metro-runtime work correctly.\n          // TODO: This module is pretty big for a function that simply re-throws an error that doesn't need to be caught.\n          // NOTE(@kitten): This is technically the public API to get polyfills rather than resolving directly into\n          // `@react-native/js-polyfills`. We should really just start vendoring these, but for now, this exclusion works\n          ...rnGetPolyfills().filter((x: string) => !x.includes('/console')),\n        ];\n      } catch (error: any) {\n        if ('code' in error && error.code === 'MODULE_NOT_FOUND') {\n          // If react-native is not installed, because we're targeting web, we still continue\n          // This should be rare, but we add it so we don't unnecessarily have a fixed peer dependency on react-native\n          debug(\n            'Skipping react-native/rn-get-polyfills from getPolyfills. react-native is not installed.'\n          );\n          return virtualModulesPolyfills;\n        } else {\n          throw error;\n        }\n      }\n    }\n\n    // Generally uses `@expo/metro-config`'s `getPolyfills` function, unless overridden\n    const polyfills = originalGetPolyfills(ctx);\n    return [\n      ...polyfills,\n      ...virtualModulesPolyfills,\n      // Removed on server platforms during the transform.\n      require.resolve('expo/virtual/streams.js'),\n    ];\n  };\n\n  return {\n    ...config,\n    serializer: {\n      ...config.serializer,\n      getPolyfills,\n    },\n  };\n}\n\nfunction normalizeSlashes(p: string) {\n  return p.replace(/\\\\/g, '/');\n}\n\nexport function getNodejsExtensions(srcExts: readonly string[]): string[] {\n  const mjsExts = srcExts.filter((ext) => /mjs$/.test(ext));\n  const nodejsSourceExtensions = srcExts.filter((ext) => !/mjs$/.test(ext));\n  // find index of last `*.js` extension\n  const jsIndex = nodejsSourceExtensions.reduce((index, ext, i) => {\n    return /jsx?$/.test(ext) ? i : index;\n  }, -1);\n\n  // insert `*.mjs` extensions after `*.js` extensions\n  nodejsSourceExtensions.splice(jsIndex + 1, 0, ...mjsExts);\n\n  return nodejsSourceExtensions;\n}\n\n/**\n * Apply custom resolvers to do the following:\n * - Disable `.native.js` extensions on web.\n * - Alias `react-native` to `react-native-web` on web.\n * - Redirect `react-native-web/dist/modules/AssetRegistry/index.js` to `@react-native/assets/registry.js` on web.\n * - Add support for `tsconfig.json`/`jsconfig.json` aliases via `compilerOptions.paths`.\n */\nexport function withExtendedResolver(\n  config: ConfigT,\n  {\n    tsconfig,\n    autolinkingModuleResolverInput,\n    isTsconfigPathsEnabled,\n    isExporting,\n    isReactServerComponentsEnabled,\n    getMetroBundler,\n  }: {\n    tsconfig: TsConfigPaths | null;\n    autolinkingModuleResolverInput?: AutolinkingModuleResolverInput;\n    isTsconfigPathsEnabled?: boolean;\n    isExporting?: boolean;\n    isReactServerComponentsEnabled?: boolean;\n    getMetroBundler: () => Bundler;\n  }\n) {\n  if (isReactServerComponentsEnabled) {\n    Log.warn(`React Server Components (beta) is enabled.`);\n  }\n\n  const aliases: { [key: string]: Record<string, string> } = {\n    web: {\n      'react-native': 'react-native-web',\n      'react-native/index': 'react-native-web',\n      'react-native/Libraries/Image/resolveAssetSource': 'expo-asset/build/resolveAssetSource',\n    },\n  };\n\n  let _universalAliases: [RegExp, string][] | null;\n\n  function getUniversalAliases() {\n    if (_universalAliases) {\n      return _universalAliases;\n    }\n\n    _universalAliases = [];\n\n    // This package is currently always installed as it is included in the `expo` package.\n    if (resolveFrom.silent(config.projectRoot, '@expo/vector-icons')) {\n      debug('Enabling alias: react-native-vector-icons -> @expo/vector-icons');\n      _universalAliases.push([/^react-native-vector-icons(\\/.*)?/, '@expo/vector-icons$1']);\n    }\n    if (isReactServerComponentsEnabled) {\n      if (resolveFrom.silent(config.projectRoot, 'expo-router/rsc')) {\n        debug('Enabling bridge alias: expo-router -> expo-router/rsc');\n        _universalAliases.push([/^expo-router$/, 'expo-router/rsc']);\n        // Bridge the internal entry point which is a standalone import to ensure package.json resolution works as expected.\n        _universalAliases.push([/^expo-router\\/entry-classic$/, 'expo-router/rsc/entry']);\n      }\n    }\n    return _universalAliases;\n  }\n\n  // used to resolve externals in `requestCustomExternals` from the project root\n  const projectRootOriginPath = path.join(config.projectRoot, 'package.json');\n\n  const preferredMainFields: { [key: string]: string[] } = {\n    // Defaults from Expo Webpack. Most packages using `react-native` don't support web\n    // in the `react-native` field, so we should prefer the `browser` field.\n    // https://github.com/expo/router/issues/37\n    web: ['browser', 'module', 'main'],\n  };\n\n  let tsConfigResolve =\n    isTsconfigPathsEnabled && (tsconfig?.paths || tsconfig?.baseUrl != null)\n      ? resolveWithTsConfigPaths.bind(resolveWithTsConfigPaths, {\n          paths: tsconfig.paths ?? {},\n          baseUrl: tsconfig.baseUrl ?? config.projectRoot,\n          hasBaseUrl: !!tsconfig.baseUrl,\n        })\n      : null;\n\n  // TODO: Move this to be a transform key for invalidation.\n  if (!isExporting && isInteractive()) {\n    if (isTsconfigPathsEnabled) {\n      // TODO: We should track all the files that used imports and invalidate them\n      // currently the user will need to save all the files that use imports to\n      // use the new aliases.\n      const configWatcher = new FileNotifier(config.projectRoot, [\n        './tsconfig.json',\n        './jsconfig.json',\n      ]);\n      configWatcher.startObserving(() => {\n        debug('Reloading tsconfig.json');\n        loadTsConfigPathsAsync(config.projectRoot).then((tsConfigPaths) => {\n          if (tsConfigPaths?.paths && !!Object.keys(tsConfigPaths.paths).length) {\n            debug('Enabling tsconfig.json paths support');\n            tsConfigResolve = resolveWithTsConfigPaths.bind(resolveWithTsConfigPaths, {\n              paths: tsConfigPaths.paths ?? {},\n              baseUrl: tsConfigPaths.baseUrl ?? config.projectRoot,\n              hasBaseUrl: !!tsConfigPaths.baseUrl,\n            });\n          } else {\n            debug('Disabling tsconfig.json paths support');\n            tsConfigResolve = null;\n          }\n        });\n      });\n\n      // TODO: This probably prevents the process from exiting.\n      installExitHooks(() => {\n        configWatcher.stopObserving();\n      });\n    } else {\n      debug('Skipping tsconfig.json paths support');\n    }\n  }\n\n  let nodejsSourceExtensions: string[] | null = null;\n\n  const getStrictResolver: StrictResolverFactory = (\n    { resolveRequest, ...context },\n    platform\n  ): StrictResolver => {\n    return function doResolve(moduleName: string): Resolution {\n      return resolver(context, moduleName, platform);\n    };\n  };\n\n  function getOptionalResolver(context: ResolutionContext, platform: string | null) {\n    const doResolve = getStrictResolver(context, platform);\n    return function optionalResolve(moduleName: string): Resolution | null {\n      try {\n        return doResolve(moduleName);\n      } catch (error) {\n        // If the error is directly related to a resolver not being able to resolve a module, then\n        // we can ignore the error and try the next resolver. Otherwise, we should throw the error.\n        const isResolutionError =\n          isFailedToResolveNameError(error) || isFailedToResolvePathError(error);\n        if (!isResolutionError) {\n          throw error;\n        }\n      }\n      return null;\n    };\n  }\n\n  // TODO: This is a hack to get resolveWeak working.\n  const idFactory = (config.serializer?.createModuleIdFactory?.() ??\n    ((id: number | string, context: { platform: string; environment?: string }): number | string =>\n      id)) as (\n    id: number | string,\n    context: { platform: string; environment?: string }\n  ) => number | string;\n\n  // We're manually resolving the `asyncRequireModulePath` since it's a module request\n  // However, in isolated installations it might not resolve from all paths, so we're resolving\n  // it from the project root manually\n  let _asyncRequireModuleResolvedPath: string | null | undefined;\n  const getAsyncRequireModule = () => {\n    if (_asyncRequireModuleResolvedPath === undefined) {\n      _asyncRequireModuleResolvedPath =\n        resolveFrom.silent(config.projectRoot, config.transformer.asyncRequireModulePath) ?? null;\n    }\n    return _asyncRequireModuleResolvedPath\n      ? ({ type: 'sourceFile', filePath: _asyncRequireModuleResolvedPath } as const)\n      : null;\n  };\n\n  const getAssetRegistryModule = () => {\n    const virtualModuleId = `\\0polyfill:assets-registry`;\n    getMetroBundlerWithVirtualModules(getMetroBundler()).setVirtualModule(\n      virtualModuleId,\n      ASSET_REGISTRY_SRC\n    );\n    return {\n      type: 'sourceFile',\n      filePath: virtualModuleId,\n    } as const;\n  };\n\n  // If Node.js pass-through, then remap to a module like `module.exports = $$require_external(<module>)`.\n  // If module should be shimmed, remap to an empty module.\n  const externals: {\n    match: (context: ResolutionContext, moduleName: string, platform: string | null) => boolean;\n    replace: 'empty' | 'node' | 'weak';\n  }[] = [\n    {\n      match: (context: ResolutionContext, moduleName: string) => {\n        if (\n          // Disable internal externals when exporting for production.\n          context.customResolverOptions.exporting ||\n          // These externals are only for Node.js environments.\n          !isServerEnvironment(context.customResolverOptions?.environment)\n        ) {\n          return false;\n        }\n\n        if (context.customResolverOptions?.environment === 'react-server') {\n          // Ensure these non-react-server modules are excluded when bundling for React Server Components in development.\n          return /^(source-map-support(\\/.*)?|@babel\\/runtime\\/.+|debug|metro-runtime\\/src\\/modules\\/HMRClient|metro|acorn-loose|acorn|chalk|ws|ansi-styles|supports-color|color-convert|has-flag|utf-8-validate|color-name|react-refresh\\/runtime|@remix-run\\/node\\/.+)$/.test(\n            moduleName\n          );\n        }\n\n        // TODO: Windows doesn't support externals somehow.\n        if (process.platform === 'win32') {\n          return /^(source-map-support(\\/.*)?)$/.test(moduleName);\n        }\n\n        // Extern these modules in standard Node.js environments in development to prevent API routes side-effects\n        // from leaking into the dev server process.\n        return /^(source-map-support(\\/.*)?|react|@radix-ui\\/.+|@babel\\/runtime\\/.+|react-dom(\\/.+)?|debug|acorn-loose|acorn|css-in-js-utils\\/lib\\/.+|hyphenate-style-name|color|color-string|color-convert|color-name|fontfaceobserver|fast-deep-equal|query-string|escape-string-regexp|invariant|postcss-value-parser|memoize-one|nullthrows|strict-uri-encode|decode-uri-component|split-on-first|filter-obj|warn-once|simple-swizzle|is-arrayish|inline-style-prefixer\\/.+)$/.test(\n          moduleName\n        );\n      },\n      replace: 'node',\n    },\n    // Externals to speed up async split chunks by extern-ing common packages that appear in the root client chunk.\n    {\n      match: (context: ResolutionContext, moduleName: string, platform: string | null) => {\n        if (\n          // Disable internal externals when exporting for production.\n          context.customResolverOptions.exporting ||\n          // These externals are only for client environments.\n          isServerEnvironment(context.customResolverOptions?.environment) ||\n          // Only enable for client boundaries\n          !context.customResolverOptions.clientboundary\n        ) {\n          return false;\n        }\n\n        // We don't support this in the resolver at the moment.\n        if (moduleName.endsWith('/package.json')) {\n          return false;\n        }\n\n        const isExternal = // Extern these modules in standard Node.js environments.\n          /^(deprecated-react-native-prop-types|react|react\\/jsx-dev-runtime|scheduler|react-native|react-dom(\\/.+)?|metro-runtime(\\/.+)?)$/.test(\n            moduleName\n          ) ||\n          // TODO: Add more\n          /^@babel\\/runtime\\/helpers\\/(wrapNativeSuper)$/.test(moduleName);\n\n        return isExternal;\n      },\n      replace: 'weak',\n    },\n  ];\n\n  const metroConfigWithCustomResolver = withMetroResolvers(config, [\n    // Mock out production react imports in development.\n    function requestDevMockProdReact(\n      context: ResolutionContext,\n      moduleName: string,\n      platform: string | null\n    ) {\n      // This resolution is dev-only to prevent bundling the production React packages in development.\n      if (!context.dev) return null;\n\n      if (\n        // Match react-native renderers.\n        (platform !== 'web' &&\n          context.originModulePath.match(/[\\\\/]node_modules[\\\\/]react-native[\\\\/]/) &&\n          moduleName.match(/([\\\\/]ReactFabric|ReactNativeRenderer)-prod/)) ||\n        // Match react production imports.\n        (moduleName.match(/\\.production(\\.min)?\\.js$/) &&\n          // Match if the import originated from a react package.\n          context.originModulePath.match(/[\\\\/]node_modules[\\\\/](react[-\\\\/]|scheduler[\\\\/])/))\n      ) {\n        debug(`Skipping production module: ${moduleName}`);\n        // /Users/path/to/expo/node_modules/react/index.js ./cjs/react.production.min.js\n        // /Users/path/to/expo/node_modules/react/jsx-dev-runtime.js ./cjs/react-jsx-dev-runtime.production.min.js\n        // /Users/path/to/expo/node_modules/react-is/index.js ./cjs/react-is.production.min.js\n        // /Users/path/to/expo/node_modules/react-refresh/runtime.js ./cjs/react-refresh-runtime.production.min.js\n        // /Users/path/to/expo/node_modules/react-native/node_modules/scheduler/index.native.js ./cjs/scheduler.native.production.min.js\n        // /Users/path/to/expo/node_modules/react-native/node_modules/react-is/index.js ./cjs/react-is.production.min.js\n        return {\n          type: 'empty',\n        };\n      }\n      return null;\n    },\n    // tsconfig paths\n    function requestTsconfigPaths(\n      context: ResolutionContext,\n      moduleName: string,\n      platform: string | null\n    ) {\n      return (\n        tsConfigResolve?.(\n          {\n            originModulePath: context.originModulePath,\n            moduleName,\n          },\n          getOptionalResolver(context, platform)\n        ) ?? null\n      );\n    },\n\n    // Node.js externals support\n    function requestNodeExternals(\n      context: ResolutionContext,\n      moduleName: string,\n      platform: string | null\n    ) {\n      const isServer =\n        context.customResolverOptions?.environment === 'node' ||\n        context.customResolverOptions?.environment === 'react-server';\n\n      const moduleId = isNodeExternal(moduleName);\n      if (!moduleId) {\n        return null;\n      }\n\n      if (\n        // In browser runtimes, we want to either resolve a local node module by the same name, or shim the module to\n        // prevent crashing when Node.js built-ins are imported.\n        !isServer\n      ) {\n        // Perform optional resolve first. If the module doesn't exist (no module in the node_modules)\n        // then we can mock the file to use an empty module.\n        const result = getOptionalResolver(context, platform)(moduleName);\n\n        if (!result && platform !== 'web') {\n          // Preserve previous behavior where native throws an error on node.js internals.\n          return null;\n        }\n\n        return (\n          result ?? {\n            // In this case, mock the file to use an empty module.\n            type: 'empty',\n          }\n        );\n      }\n      const contents = `module.exports=$$require_external('node:${moduleId}');`;\n      debug(`Virtualizing Node.js \"${moduleId}\"`);\n      const virtualModuleId = `\\0node:${moduleId}`;\n      getMetroBundlerWithVirtualModules(getMetroBundler()).setVirtualModule(\n        virtualModuleId,\n        contents\n      );\n      return {\n        type: 'sourceFile',\n        filePath: virtualModuleId,\n      };\n    },\n\n    // Custom externals support\n    function requestCustomExternals(\n      context: ResolutionContext,\n      moduleName: string,\n      platform: string | null\n    ) {\n      // We don't support this in the resolver at the moment.\n      if (moduleName.endsWith('/package.json')) {\n        return null;\n      }\n      // Skip applying JS externals for CSS files.\n      if (/\\.(s?css|sass)$/.test(context.originModulePath)) {\n        return null;\n      }\n\n      for (const external of externals) {\n        if (external.match(context, moduleName, platform)) {\n          if (external.replace === 'empty') {\n            debug(`Redirecting external \"${moduleName}\" to \"${external.replace}\"`);\n            return {\n              type: external.replace,\n            };\n          } else if (external.replace === 'weak') {\n            // TODO: Make this use require.resolveWeak again. Previously this was just resolving to the same path.\n            const realModule = getStrictResolver(context, platform)(moduleName);\n            const realPath = realModule.type === 'sourceFile' ? realModule.filePath : moduleName;\n            const opaqueId = idFactory(realPath, {\n              platform: platform!,\n              environment: context.customResolverOptions?.environment,\n            });\n            const contents =\n              typeof opaqueId === 'number'\n                ? `module.exports=/*${moduleName}*/__r(${opaqueId})`\n                : `module.exports=/*${moduleName}*/__r(${JSON.stringify(opaqueId)})`;\n            // const contents = `module.exports=/*${moduleName}*/__r(require.resolveWeak('${moduleName}'))`;\n            // const generatedModuleId = fastHashMemoized(contents);\n            const virtualModuleId = `\\0weak:${opaqueId}`;\n            debug('Virtualizing module:', moduleName, '->', virtualModuleId);\n            getMetroBundlerWithVirtualModules(getMetroBundler()).setVirtualModule(\n              virtualModuleId,\n              contents\n            );\n            return {\n              type: 'sourceFile',\n              filePath: virtualModuleId,\n            };\n          } else if (external.replace === 'node') {\n            // TODO(@kitten): Temporary workaround. Our externals logic here isn't generic and only works\n            // for development and not exports. We never intend to use it in exported production bundles,\n            // however, this is still a dangerous implementation. To protect us from externalizing modules\n            // that aren't available to the app, we force any resolution to happen via the project root\n            const projectRootContext: ResolutionContext = {\n              ...context,\n              nodeModulesPaths: [],\n              originModulePath: projectRootOriginPath,\n              disableHierarchicalLookup: false,\n            };\n            const externModule = getStrictResolver(projectRootContext, platform)(moduleName);\n            if (externModule.type !== 'sourceFile') {\n              return null;\n            }\n            const contents = `module.exports=$$require_external('${moduleName}')`;\n            const virtualModuleId = `\\0node:${moduleName}`;\n            debug('Virtualizing Node.js (custom):', moduleName, '->', virtualModuleId);\n            getMetroBundlerWithVirtualModules(getMetroBundler()).setVirtualModule(\n              virtualModuleId,\n              contents\n            );\n            return {\n              type: 'sourceFile',\n              filePath: virtualModuleId,\n            };\n          } else {\n            external.replace satisfies never;\n          }\n        }\n      }\n      return null;\n    },\n\n    // Basic moduleId aliases\n    function requestAlias(context: ResolutionContext, moduleName: string, platform: string | null) {\n      // Conditionally remap `react-native` to `react-native-web` on web in\n      // a way that doesn't require Babel to resolve the alias.\n      if (platform && platform in aliases && aliases[platform][moduleName]) {\n        const redirectedModuleName = aliases[platform][moduleName];\n        return getStrictResolver(context, platform)(redirectedModuleName);\n      }\n\n      for (const [matcher, alias] of getUniversalAliases()) {\n        const match = moduleName.match(matcher);\n        if (match) {\n          const aliasedModule = alias.replace(\n            /\\$(\\d+)/g,\n            (_, index) => match[parseInt(index, 10)] ?? ''\n          );\n          const doResolve = getStrictResolver(context, platform);\n          debug(`Alias \"${moduleName}\" to \"${aliasedModule}\"`);\n          return doResolve(aliasedModule);\n        }\n      }\n\n      return null;\n    },\n\n    // Polyfill for asset registry (assetRegistryPath) and async require module (asyncRequireModulePath)\n    function requestStableConfigModules(\n      context: ResolutionContext,\n      moduleName: string,\n      platform: string | null\n    ) {\n      if (moduleName === config.transformer.asyncRequireModulePath) {\n        return getAsyncRequireModule();\n      }\n\n      // TODO(@kitten): Compare against `config.transformer.assetRegistryPath`\n      if (/^@react-native\\/assets-registry\\/registry(\\.js)?$/.test(moduleName)) {\n        return getAssetRegistryModule();\n      }\n\n      if (\n        platform === 'web' &&\n        context.originModulePath.match(/node_modules[\\\\/]react-native-web[\\\\/]/) &&\n        moduleName.includes('/modules/AssetRegistry')\n      ) {\n        return getAssetRegistryModule();\n      }\n\n      return null;\n    },\n\n    createAutolinkingModuleResolver(autolinkingModuleResolverInput, {\n      getStrictResolver,\n    }),\n\n    // TODO: Reduce these as much as possible in the future.\n    // Complex post-resolution rewrites.\n    function requestPostRewrites(\n      context: ResolutionContext,\n      moduleName: string,\n      platform: string | null\n    ) {\n      const doResolve = getStrictResolver(context, platform);\n\n      const result = doResolve(moduleName);\n\n      if (result.type !== 'sourceFile') {\n        return result;\n      }\n\n      const normalizedPath = normalizeSlashes(result.filePath);\n\n      const doReplace = (from: string, to: string | undefined, options?: { throws?: boolean }) =>\n        doReplaceHelper(from, to, {\n          normalizedPath,\n          doResolve,\n          ...options,\n        });\n      const doReplaceStrict = (from: string, to: string | undefined) =>\n        doReplace(from, to, { throws: true });\n\n      if (env.EXPO_UNSTABLE_WEB_MODAL) {\n        const webModalModule = doReplace(\n          'expo-router/build/layouts/_web-modal.js',\n          'expo-router/build/layouts/ExperimentalModalStack.js'\n        );\n        if (webModalModule) {\n          debug('Using `_unstable-web-modal` implementation.');\n          return webModalModule;\n        }\n      }\n\n      if (platform === 'web') {\n        if (result.filePath.includes('node_modules')) {\n          // Disallow importing confusing native modules on web\n          if (\n            [\n              'react-native/Libraries/ReactPrivate/ReactNativePrivateInitializeCore',\n              'react-native/Libraries/Utilities/codegenNativeCommands',\n              'react-native/Libraries/Utilities/codegenNativeComponent',\n            ].some((matcher) =>\n              // Support absolute and modules with .js extensions.\n              moduleName.includes(matcher)\n            )\n          ) {\n            throw new FailedToResolveNativeOnlyModuleError(\n              moduleName,\n              path.relative(config.projectRoot, context.originModulePath)\n            );\n          }\n\n          // Replace with static shims\n\n          // Drop everything up until the `node_modules` folder.\n          const normalName = normalizedPath.replace(/.*node_modules\\//, '');\n\n          const shimFile = shouldCreateVirtualShim(normalName);\n          if (shimFile) {\n            const virtualId = `\\0shim:${normalName}`;\n            const bundler = getMetroBundlerWithVirtualModules(getMetroBundler());\n            if (!bundler.hasVirtualModule(virtualId)) {\n              bundler.setVirtualModule(virtualId, fs.readFileSync(shimFile, 'utf8'));\n            }\n            debug(`Redirecting module \"${result.filePath}\" to shim`);\n\n            return {\n              ...result,\n              filePath: virtualId,\n            };\n          }\n        }\n      } else {\n        const isServer =\n          context.customResolverOptions?.environment === 'node' ||\n          context.customResolverOptions?.environment === 'react-server';\n\n        // Shim out React Native native runtime globals in server mode for native.\n        if (isServer) {\n          const emptyModule = doReplace('react-native/Libraries/Core/InitializeCore.js', undefined);\n          if (emptyModule) {\n            debug('Shimming out InitializeCore for React Native in native SSR bundle');\n            return emptyModule;\n          }\n        }\n\n        const hmrModule = doReplaceStrict(\n          'react-native/Libraries/Utilities/HMRClient.js',\n          'expo/src/async-require/hmr.ts'\n        );\n        if (hmrModule) return hmrModule;\n\n        if (env.EXPO_UNSTABLE_LOG_BOX) {\n          const logBoxModule = doReplace(\n            'react-native/Libraries/LogBox/LogBoxInspectorContainer.js',\n            '@expo/log-box/swap-rn-logbox.js'\n          );\n          if (logBoxModule) return logBoxModule;\n\n          const logBoxParserModule = doReplace(\n            'react-native/Libraries/LogBox/Data/parseLogBoxLog.js',\n            '@expo/log-box/swap-rn-logbox-parser.js'\n          );\n          if (logBoxParserModule) return logBoxParserModule;\n        }\n      }\n\n      return result;\n    },\n\n    // If at this point, we haven't resolved a module yet, if it's a module specifier for a known dependency\n    // of either `expo` or `expo-router`, attempt to resolve it from these origin modules instead\n    createFallbackModuleResolver({\n      projectRoot: config.projectRoot,\n      originModuleNames: ['expo', 'expo-router'],\n      getStrictResolver,\n    }),\n  ]);\n\n  // Ensure we mutate the resolution context to include the custom resolver options for server and web.\n  const metroConfigWithCustomContext = withMetroMutatedResolverContext(\n    metroConfigWithCustomResolver,\n    (\n      immutableContext: CustomResolutionContext,\n      moduleName: string,\n      platform: string | null\n    ): CustomResolutionContext => {\n      const context = asWritable({\n        ...immutableContext,\n        preferNativePlatform: platform !== 'web',\n      });\n\n      if (isServerEnvironment(context.customResolverOptions?.environment)) {\n        // Adjust nodejs source extensions to sort mjs after js, including platform variants.\n        if (nodejsSourceExtensions === null) {\n          nodejsSourceExtensions = getNodejsExtensions(context.sourceExts);\n        }\n        context.sourceExts = nodejsSourceExtensions;\n\n        context.unstable_enablePackageExports = true;\n        context.unstable_conditionsByPlatform = {};\n\n        const isReactServerComponents =\n          context.customResolverOptions?.environment === 'react-server';\n\n        if (isReactServerComponents) {\n          // NOTE: Align the behavior across server and client. This is a breaking change so we'll just roll it out with React Server Components.\n          // This ensures that react-server and client code both resolve `module` and `main` in the same order.\n          if (platform === 'web') {\n            // Node.js runtimes should only be importing main at the moment.\n            // This is a temporary fix until we can support the package.json exports.\n            context.mainFields = ['module', 'main'];\n          } else {\n            // In Node.js + native, use the standard main fields.\n            context.mainFields = ['react-native', 'module', 'main'];\n          }\n        } else {\n          if (platform === 'web') {\n            // Node.js runtimes should only be importing main at the moment.\n            // This is a temporary fix until we can support the package.json exports.\n            context.mainFields = ['main', 'module'];\n          } else {\n            // In Node.js + native, use the standard main fields.\n            context.mainFields = ['react-native', 'main', 'module'];\n          }\n        }\n\n        // Enable react-server import conditions.\n        if (context.customResolverOptions?.environment === 'react-server') {\n          context.unstable_conditionNames = ['node', 'react-server', 'workerd'];\n        } else {\n          context.unstable_conditionNames = ['node'];\n        }\n      } else {\n        // Non-server changes\n\n        if (!env.EXPO_METRO_NO_MAIN_FIELD_OVERRIDE && platform && platform in preferredMainFields) {\n          context.mainFields = preferredMainFields[platform];\n        }\n      }\n\n      return context;\n    }\n  );\n\n  return withMetroErrorReportingResolver(\n    withMetroSupervisingTransformWorker(metroConfigWithCustomContext)\n  );\n}\n\nfunction doReplaceHelper(\n  from: string,\n  to: string | undefined,\n  {\n    throws = false,\n    normalizedPath,\n    doResolve,\n  }: {\n    throws?: boolean;\n    normalizedPath: string;\n    doResolve: StrictResolver;\n  }\n): SourceFileResolution | { type: 'empty' } | undefined {\n  if (!normalizedPath.endsWith(from)) {\n    return undefined;\n  }\n\n  if (to === undefined) {\n    return {\n      type: 'empty',\n    };\n  }\n\n  try {\n    const hmrModule = doResolve(to);\n    if (hmrModule.type === 'sourceFile') {\n      debug(`Using \\`${to}\\` implementation.`);\n      return hmrModule;\n    }\n  } catch (resolutionError) {\n    if (throws) {\n      throw new Error(`Failed to replace ${from} with ${to}. Resolution of ${to} failed.`, {\n        cause: resolutionError,\n      });\n    }\n\n    debug(`Failed to resolve ${to} when swapping from ${from}: ${resolutionError}`);\n  }\n  return undefined;\n}\n\n/** @returns `true` if the incoming resolution should be swapped. */\nexport function shouldAliasModule(\n  input: {\n    platform: string | null;\n    result: Resolution;\n  },\n  alias: { platform: string; output: string }\n): boolean {\n  return (\n    input.platform === alias.platform &&\n    input.result?.type === 'sourceFile' &&\n    typeof input.result?.filePath === 'string' &&\n    normalizeSlashes(input.result.filePath).endsWith(alias.output)\n  );\n}\n\n/** Add support for `react-native-web` and the Web platform. */\nexport async function withMetroMultiPlatformAsync(\n  projectRoot: string,\n  {\n    config,\n    exp,\n    platformBundlers,\n    isTsconfigPathsEnabled,\n    isAutolinkingResolverEnabled,\n    isExporting,\n\n    isReactServerComponentsEnabled,\n    getMetroBundler,\n  }: {\n    config: ConfigT;\n    exp: ExpoConfig;\n    isTsconfigPathsEnabled: boolean;\n    platformBundlers: PlatformBundlers;\n    isAutolinkingResolverEnabled?: boolean;\n    isExporting?: boolean;\n\n    isReactServerComponentsEnabled: boolean;\n    isNamedRequiresEnabled: boolean;\n    getMetroBundler: () => Bundler;\n  }\n) {\n  // Change the default metro-runtime to a custom one that supports bundle splitting.\n  // NOTE(@kitten): This is now always active and EXPO_USE_METRO_REQUIRE / isNamedRequiresEnabled is disregarded\n  const metroDefaults: typeof import('@expo/metro/metro-config/defaults/defaults') = require('@expo/metro/metro-config/defaults/defaults');\n  asWritable(metroDefaults).moduleSystem = require.resolve('@expo/cli/build/metro-require/require');\n\n  // Required for @expo/metro-runtime to format paths in the web LogBox.\n  process.env.EXPO_PUBLIC_PROJECT_ROOT = process.env.EXPO_PUBLIC_PROJECT_ROOT ?? projectRoot;\n\n  // This is used for running Expo CLI in development against projects outside the monorepo.\n  if (!isDirectoryIn(__dirname, projectRoot)) {\n    const watchFolders = (config.watchFolders as string[]) || [];\n    asWritable(config).watchFolders = watchFolders;\n\n    watchFolders.push(path.join(require.resolve('metro-runtime/package.json'), '../..'));\n    watchFolders.push(\n      path.join(require.resolve('@expo/metro-config/package.json'), '../..'),\n      // For virtual modules\n      path.join(require.resolve('expo/package.json'), '..')\n    );\n  }\n\n  let tsconfig: null | TsConfigPaths = null;\n\n  if (isTsconfigPathsEnabled) {\n    tsconfig = await loadTsConfigPathsAsync(projectRoot);\n  }\n\n  let expoConfigPlatforms = Object.entries(platformBundlers)\n    .filter(\n      ([platform, bundler]) => bundler === 'metro' && exp.platforms?.includes(platform as Platform)\n    )\n    .map(([platform]) => platform);\n\n  if (Array.isArray(config.resolver.platforms)) {\n    expoConfigPlatforms = [...new Set(expoConfigPlatforms.concat(config.resolver.platforms))];\n  }\n\n  asWritable(config.resolver).platforms = expoConfigPlatforms;\n\n  config = withWebPolyfills(config, { getMetroBundler });\n\n  let autolinkingModuleResolverInput: AutolinkingModuleResolverInput | undefined;\n  if (isAutolinkingResolverEnabled) {\n    autolinkingModuleResolverInput = await createAutolinkingModuleResolverInput({\n      platforms: expoConfigPlatforms,\n      projectRoot,\n    });\n  }\n\n  return withExtendedResolver(config, {\n    autolinkingModuleResolverInput,\n    tsconfig,\n    isExporting,\n    isTsconfigPathsEnabled,\n    isReactServerComponentsEnabled,\n    getMetroBundler,\n  });\n}\n\nfunction isDirectoryIn(targetPath: string, rootPath: string) {\n  return targetPath.startsWith(rootPath) && targetPath.length >= rootPath.length;\n}\n"],"names":["getNodejsExtensions","shouldAliasModule","withExtendedResolver","withMetroMultiPlatformAsync","ASSET_REGISTRY_SRC","debug","require","asWritable","input","withWebPolyfills","config","getMetroBundler","originalGetPolyfills","serializer","getPolyfills","bind","ctx","virtualEnvVarId","getMetroBundlerWithVirtualModules","setVirtualModule","virtualModuleId","platform","virtualModulesPolyfills","rnGetPolyfills","filter","x","includes","error","code","polyfills","resolve","normalizeSlashes","p","replace","srcExts","mjsExts","ext","test","nodejsSourceExtensions","jsIndex","reduce","index","i","splice","tsconfig","autolinkingModuleResolverInput","isTsconfigPathsEnabled","isExporting","isReactServerComponentsEnabled","Log","warn","aliases","web","_universalAliases","getUniversalAliases","resolveFrom","silent","projectRoot","push","projectRootOriginPath","path","join","preferredMainFields","tsConfigResolve","paths","baseUrl","resolveWithTsConfigPaths","hasBaseUrl","isInteractive","configWatcher","FileNotifier","startObserving","loadTsConfigPathsAsync","then","tsConfigPaths","Object","keys","length","installExitHooks","stopObserving","getStrictResolver","resolveRequest","context","doResolve","moduleName","resolver","getOptionalResolver","optionalResolve","isResolutionError","isFailedToResolveNameError","isFailedToResolvePathError","idFactory","createModuleIdFactory","id","_asyncRequireModuleResolvedPath","getAsyncRequireModule","undefined","transformer","asyncRequireModulePath","type","filePath","getAssetRegistryModule","externals","match","customResolverOptions","exporting","isServerEnvironment","environment","process","clientboundary","endsWith","isExternal","metroConfigWithCustomResolver","withMetroResolvers","requestDevMockProdReact","dev","originModulePath","requestTsconfigPaths","requestNodeExternals","isServer","moduleId","isNodeExternal","result","contents","requestCustomExternals","external","realModule","realPath","opaqueId","JSON","stringify","projectRootContext","nodeModulesPaths","disableHierarchicalLookup","externModule","requestAlias","redirectedModuleName","matcher","alias","aliasedModule","_","parseInt","requestStableConfigModules","createAutolinkingModuleResolver","requestPostRewrites","normalizedPath","doReplace","from","to","options","doReplaceHelper","doReplaceStrict","throws","env","EXPO_UNSTABLE_WEB_MODAL","webModalModule","some","FailedToResolveNativeOnlyModuleError","relative","normalName","shimFile","shouldCreateVirtualShim","virtualId","bundler","hasVirtualModule","fs","readFileSync","emptyModule","hmrModule","EXPO_UNSTABLE_LOG_BOX","logBoxModule","logBoxParserModule","createFallbackModuleResolver","originModuleNames","metroConfigWithCustomContext","withMetroMutatedResolverContext","immutableContext","preferNativePlatform","sourceExts","unstable_enablePackageExports","unstable_conditionsByPlatform","isReactServerComponents","mainFields","unstable_conditionNames","EXPO_METRO_NO_MAIN_FIELD_OVERRIDE","withMetroErrorReportingResolver","withMetroSupervisingTransformWorker","resolutionError","Error","cause","output","exp","platformBundlers","isAutolinkingResolverEnabled","metroDefaults","moduleSystem","EXPO_PUBLIC_PROJECT_ROOT","isDirectoryIn","__dirname","watchFolders","expoConfigPlatforms","entries","platforms","map","Array","isArray","Set","concat","createAutolinkingModuleResolverInput","targetPath","rootPath","startsWith"],"mappings":"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"}