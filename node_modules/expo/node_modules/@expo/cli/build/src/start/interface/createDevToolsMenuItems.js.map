{"version":3,"sources":["../../../../src/start/interface/createDevToolsMenuItems.ts"],"sourcesContent":["import chalk from 'chalk';\n\nimport { cliExtensionMenuItemHandler } from './cliExtensionMenuItemHandler';\nimport * as Log from '../../log';\nimport { openBrowserAsync } from '../../utils/open';\nimport { ExpoChoice, selectAsync } from '../../utils/prompts';\nimport { DevToolsPlugin } from '../server/DevToolsPlugin';\nimport { DevToolsPluginCommand } from '../server/DevToolsPlugin.schema';\n\nconst debug = require('debug')('expo:start:devtools') as typeof console.log;\n\nexport interface MoreToolMenuItem extends ExpoChoice<string> {\n  action?: () => unknown;\n}\n\ntype MenuItemWithSubmenu = MoreToolMenuItem & {\n  children?: MenuItemWithSubmenu[];\n};\n\ntype CliExtensionMenuItemHandler = (\n  plugin: DevToolsPlugin,\n  cmd: DevToolsPluginCommand,\n  metroServerOrigin: string\n) => Promise<void>;\n\n/**\n * Creates the menu items for the DevTools interface.\n * @param plugins The list of DevTools plugins.\n * @param defaultServerUrl The default server URL.\n * @param metroServerOrigin The Metro server origin.\n * @param cliExtensionMenuItemHandlerFunc The function to handle CLI extension menu items.\n * @param openBrowserAsyncFunc The function to open the browser.\n * @returns The menu items for the DevTools interface.\n */\nexport const createDevToolsMenuItems = (\n  plugins: DevToolsPlugin[],\n  defaultServerUrl: string,\n  metroServerOrigin: string,\n  cliExtensionMenuItemHandlerFunc: CliExtensionMenuItemHandler = cliExtensionMenuItemHandler, // Used for injection when testing\n  openBrowserAsyncFunc: typeof openBrowserAsync = openBrowserAsync // Used for injection when testing\n): MenuItemWithSubmenu[] => {\n  return plugins\n    .map((plugin) => {\n      const commands = getCliExtensionCommands(plugin);\n      if (commands.length > 0 && plugin.webpageEndpoint) {\n        // Custom display/handling for plugins that support both web and CLI commands\n        const children = [\n          devtoolFactory(plugin, defaultServerUrl, openBrowserAsyncFunc),\n          ...commands.map((descriptor) => ({\n            title: descriptor.title,\n            value: descriptor.name,\n            action: async () =>\n              await cliExtensionMenuItemHandlerFunc(plugin, descriptor, metroServerOrigin),\n          })),\n        ].filter((item) => item != null);\n        return {\n          title: chalk`{bold ${plugin.packageName}}`,\n          value: '',\n          children,\n          action: async () => {\n            try {\n              const value = await selectAsync(chalk`{dim Select command}`, children);\n              await children.find((item) => item.value === value)?.action?.();\n            } catch (error: any) {\n              // Handle aborting prompt\n              debug(`Aborted selection prompt by user: ${error.toString()}`);\n            }\n          },\n        };\n      } else if (plugin.webpageEndpoint) {\n        return devtoolFactory(plugin, defaultServerUrl);\n      } else if (plugin.cliExtensions && commands.length > 0) {\n        return cliExtensionFactory(plugin, metroServerOrigin);\n      }\n      return null;\n    })\n    .filter((menuItem) => menuItem != null);\n};\n\nconst devtoolFactory = (\n  plugin: DevToolsPlugin,\n  defaultServerUrl: string,\n  openBrowserAsyncFunc: typeof openBrowserAsync = openBrowserAsync // Used for injection when testing\n): MoreToolMenuItem | null => {\n  if (plugin.webpageEndpoint == null) {\n    return null;\n  }\n\n  return {\n    title: chalk`Open {bold ${plugin.packageName}}`,\n    value: `devtoolsPlugin:${plugin.packageName}`,\n    action: async () => {\n      const url = new URL(plugin.webpageEndpoint!, defaultServerUrl);\n      await openBrowserAsyncFunc(url.toString());\n    },\n  };\n};\n\nconst getCliExtensionCommands = (plugin: DevToolsPlugin): DevToolsPluginCommand[] => {\n  const cliExtensionsConfig = plugin.cliExtensions;\n  const commands = (cliExtensionsConfig?.commands ?? []).filter((p) =>\n    p.environments?.includes('cli')\n  );\n\n  if (cliExtensionsConfig == null || commands.length === 0) {\n    return [];\n  }\n  return commands;\n};\n\nconst cliExtensionFactory = (\n  plugin: DevToolsPlugin,\n  metroServerOrigin: string,\n  cliExtensionMenuItemHandlerFunc: CliExtensionMenuItemHandler = cliExtensionMenuItemHandler // Used for injection when testing\n): MenuItemWithSubmenu | null => {\n  const commands = getCliExtensionCommands(plugin);\n  const children = commands.map((cmd) => ({\n    title: cmd.title,\n    value: cmd.name,\n  }));\n\n  return {\n    title: chalk`{bold ${plugin.packageName}}`,\n    value: `cliExtension:${plugin.packageName}`,\n    children,\n    action: async () => {\n      try {\n        const value = await selectAsync(chalk`{dim Select command}`, children);\n        const cmd = commands.find((c) => c.name === value);\n        if (cmd == null) {\n          Log.warn(`No command found for ${plugin.packageName}`);\n        } else {\n          await cliExtensionMenuItemHandlerFunc(plugin, cmd, metroServerOrigin);\n        }\n      } catch (error: any) {\n        // Handle aborting prompt\n        debug(`Failed to execute command: ${error.toString()}`);\n      }\n    },\n  };\n};\n"],"names":["createDevToolsMenuItems","debug","require","plugins","defaultServerUrl","metroServerOrigin","cliExtensionMenuItemHandlerFunc","cliExtensionMenuItemHandler","openBrowserAsyncFunc","openBrowserAsync","map","plugin","commands","getCliExtensionCommands","length","webpageEndpoint","children","devtoolFactory","descriptor","title","value","name","action","filter","item","chalk","packageName","selectAsync","find","error","toString","cliExtensions","cliExtensionFactory","menuItem","url","URL","cliExtensionsConfig","p","environments","includes","cmd","c","Log","warn"],"mappings":"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"}