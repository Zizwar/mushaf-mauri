{"version":3,"sources":["../../../../src/start/interface/cliExtensionMenuItemHandler.ts"],"sourcesContent":["import chalk from 'chalk';\nimport { Ora } from 'ora';\n\nimport * as Log from '../../log';\nimport { link } from '../../utils/link';\nimport { ora } from '../../utils/ora';\nimport { promptAsync } from '../../utils/prompts';\nimport { DevToolsPlugin } from '../server/DevToolsPlugin';\nimport { DevToolsPluginCommand, DevToolsPluginOutput } from '../server/DevToolsPlugin.schema';\n\n/**\n * Handles the CLI extension menu item selection and execution of the plugin command for use\n * in the cli context, logging to the terminal.\n *\n * The function will prompt for any required parameters, confirm execution, and display\n * output from the command execution.\n *\n * @param plugin The DevTools plugin.\n * @param command The command to execute.\n * @param metroServerOrigin The Metro server origin.\n * @returns\n */\nexport const cliExtensionMenuItemHandler = async (\n  plugin: DevToolsPlugin,\n  command: DevToolsPluginCommand,\n  metroServerOrigin: string\n) => {\n  const cliExtensionsConfig = plugin.cliExtensions;\n  if (cliExtensionsConfig == null) {\n    return;\n  }\n\n  if (plugin.executor == null) {\n    Log.warn(chalk`{bold ${plugin.packageName}} does not support CLI commands.`);\n    return;\n  }\n\n  let args: Record<string, string> = {};\n  if (command.parameters && command.parameters.length > 0) {\n    args = await command.parameters.reduce(\n      async (accPromise, param) => {\n        const acc = await accPromise;\n        const result = await promptAsync({\n          name: param.name,\n          type: param.type,\n          message:\n            `${param.name}${param.description ? chalk` {dim ${param.description}}` : ''}` +\n            chalk` {dim (${param.type})}`,\n        });\n        if (result[param.name] == null) {\n          throw new Error('Input cancelled');\n        }\n        return { ...acc, [param.name]: result[param.name] };\n      },\n      Promise.resolve({} as Record<string, string>)\n    );\n  }\n\n  // Confirm execution\n  const { value } = await promptAsync({\n    message: chalk`{dim Execute command \"${command.title}\":} \"${plugin.executor.getCommandString({ command: command.name, args })}\"`,\n    initial: false,\n    name: 'value',\n    type: 'confirm',\n  });\n\n  if (!value) {\n    return;\n  }\n\n  const spinnerText = `Executing command '${command.title}'`;\n  const spinner = ora(spinnerText).start();\n\n  try {\n    // Execute and stream the output\n    const results = await plugin.executor.execute({\n      command: command.name,\n      metroServerOrigin,\n      args,\n      onOutput: (output) => handleOutput(output, spinner),\n    });\n\n    // Format with warning or success depending on wether the client reported any errors\n    formatResults(command.title, results, spinner);\n  } catch (error: any) {\n    spinner.fail(`Failed to execute command \"${command.title}\".\\n${error.toString().trim()}`);\n  }\n};\n\n//*************************** Helpers ****************************/\n\nfunction normalizeText(text: string, level: 'info' | 'warning' | 'error') {\n  const trimText = text.trim();\n  if (level === 'error') {\n    return chalk.red(trimText);\n  } else if (level === 'warning') {\n    return chalk.yellow(trimText);\n  } else {\n    return trimText;\n  }\n}\n\nfunction appendSpinnerText(text: string, spinner: Ora) {\n  return (spinner.text += '\\n  ' + text);\n}\n\nfunction handleOutput(output: DevToolsPluginOutput, spinner: Ora) {\n  output.forEach((line) => {\n    switch (line.type) {\n      case 'text':\n        appendSpinnerText(\n          line.url\n            ? link(line.url, { text: normalizeText(line.text, line.level), dim: false })\n            : normalizeText(line.text, line.level),\n          spinner\n        );\n        break;\n      case 'audio':\n        appendSpinnerText(link(line.url, { text: line.text ?? 'Audio', dim: false }), spinner);\n        break;\n      case 'image':\n        appendSpinnerText(link(line.url, { text: line.text ?? 'Image', dim: false }), spinner);\n        break;\n    }\n  });\n}\n\nfunction formatResults(command: string, results: DevToolsPluginOutput, spinner: Ora) {\n  const output = spinner.text.split('\\n').slice(1).join('\\n');\n  if (results.find((line) => line.type === 'text' && line.level === 'error')) {\n    spinner.fail(`Command \"${command}\" completed with errors.\\n${output}`);\n  } else if (results.find((line) => line.type === 'text' && line.level === 'warning')) {\n    spinner.warn(`Command \"${command}\" completed with warnings.\\n${output}`);\n  } else {\n    spinner.succeed(`Command \"${command}\" completed successfully.\\n${output}`).stop();\n  }\n}\n"],"names":["cliExtensionMenuItemHandler","plugin","command","metroServerOrigin","cliExtensionsConfig","cliExtensions","executor","Log","warn","chalk","packageName","args","parameters","length","reduce","accPromise","param","acc","result","promptAsync","name","type","message","description","Error","Promise","resolve","value","title","getCommandString","initial","spinnerText","spinner","ora","start","results","execute","onOutput","output","handleOutput","formatResults","error","fail","toString","trim","normalizeText","text","level","trimText","red","yellow","appendSpinnerText","forEach","line","url","link","dim","split","slice","join","find","succeed","stop"],"mappings":";;;;+BAsBaA;;;eAAAA;;;;gEAtBK;;;;;;6DAGG;sBACA;qBACD;yBACQ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAgBrB,MAAMA,8BAA8B,OACzCC,QACAC,SACAC;IAEA,MAAMC,sBAAsBH,OAAOI,aAAa;IAChD,IAAID,uBAAuB,MAAM;QAC/B;IACF;IAEA,IAAIH,OAAOK,QAAQ,IAAI,MAAM;QAC3BC,KAAIC,IAAI,CAACC,IAAAA,gBAAK,CAAA,CAAC,MAAM,EAAER,OAAOS,WAAW,CAAC,gCAAgC,CAAC;QAC3E;IACF;IAEA,IAAIC,OAA+B,CAAC;IACpC,IAAIT,QAAQU,UAAU,IAAIV,QAAQU,UAAU,CAACC,MAAM,GAAG,GAAG;QACvDF,OAAO,MAAMT,QAAQU,UAAU,CAACE,MAAM,CACpC,OAAOC,YAAYC;YACjB,MAAMC,MAAM,MAAMF;YAClB,MAAMG,SAAS,MAAMC,IAAAA,oBAAW,EAAC;gBAC/BC,MAAMJ,MAAMI,IAAI;gBAChBC,MAAML,MAAMK,IAAI;gBAChBC,SACE,GAAGN,MAAMI,IAAI,GAAGJ,MAAMO,WAAW,GAAGd,IAAAA,gBAAK,CAAA,CAAC,MAAM,EAAEO,MAAMO,WAAW,CAAC,CAAC,CAAC,GAAG,IAAI,GAC7Ed,IAAAA,gBAAK,CAAA,CAAC,OAAO,EAAEO,MAAMK,IAAI,CAAC,EAAE,CAAC;YACjC;YACA,IAAIH,MAAM,CAACF,MAAMI,IAAI,CAAC,IAAI,MAAM;gBAC9B,MAAM,IAAII,MAAM;YAClB;YACA,OAAO;gBAAE,GAAGP,GAAG;gBAAE,CAACD,MAAMI,IAAI,CAAC,EAAEF,MAAM,CAACF,MAAMI,IAAI,CAAC;YAAC;QACpD,GACAK,QAAQC,OAAO,CAAC,CAAC;IAErB;IAEA,oBAAoB;IACpB,MAAM,EAAEC,KAAK,EAAE,GAAG,MAAMR,IAAAA,oBAAW,EAAC;QAClCG,SAASb,IAAAA,gBAAK,CAAA,CAAC,sBAAsB,EAAEP,QAAQ0B,KAAK,CAAC,KAAK,EAAE3B,OAAOK,QAAQ,CAACuB,gBAAgB,CAAC;YAAE3B,SAASA,QAAQkB,IAAI;YAAET;QAAK,GAAG,CAAC,CAAC;QAChImB,SAAS;QACTV,MAAM;QACNC,MAAM;IACR;IAEA,IAAI,CAACM,OAAO;QACV;IACF;IAEA,MAAMI,cAAc,CAAC,mBAAmB,EAAE7B,QAAQ0B,KAAK,CAAC,CAAC,CAAC;IAC1D,MAAMI,UAAUC,IAAAA,QAAG,EAACF,aAAaG,KAAK;IAEtC,IAAI;QACF,gCAAgC;QAChC,MAAMC,UAAU,MAAMlC,OAAOK,QAAQ,CAAC8B,OAAO,CAAC;YAC5ClC,SAASA,QAAQkB,IAAI;YACrBjB;YACAQ;YACA0B,UAAU,CAACC,SAAWC,aAAaD,QAAQN;QAC7C;QAEA,oFAAoF;QACpFQ,cAActC,QAAQ0B,KAAK,EAAEO,SAASH;IACxC,EAAE,OAAOS,OAAY;QACnBT,QAAQU,IAAI,CAAC,CAAC,2BAA2B,EAAExC,QAAQ0B,KAAK,CAAC,IAAI,EAAEa,MAAME,QAAQ,GAAGC,IAAI,IAAI;IAC1F;AACF;AAEA,mEAAmE;AAEnE,SAASC,cAAcC,IAAY,EAAEC,KAAmC;IACtE,MAAMC,WAAWF,KAAKF,IAAI;IAC1B,IAAIG,UAAU,SAAS;QACrB,OAAOtC,gBAAK,CAACwC,GAAG,CAACD;IACnB,OAAO,IAAID,UAAU,WAAW;QAC9B,OAAOtC,gBAAK,CAACyC,MAAM,CAACF;IACtB,OAAO;QACL,OAAOA;IACT;AACF;AAEA,SAASG,kBAAkBL,IAAY,EAAEd,OAAY;IACnD,OAAQA,QAAQc,IAAI,IAAI,SAASA;AACnC;AAEA,SAASP,aAAaD,MAA4B,EAAEN,OAAY;IAC9DM,OAAOc,OAAO,CAAC,CAACC;QACd,OAAQA,KAAKhC,IAAI;YACf,KAAK;gBACH8B,kBACEE,KAAKC,GAAG,GACJC,IAAAA,UAAI,EAACF,KAAKC,GAAG,EAAE;oBAAER,MAAMD,cAAcQ,KAAKP,IAAI,EAAEO,KAAKN,KAAK;oBAAGS,KAAK;gBAAM,KACxEX,cAAcQ,KAAKP,IAAI,EAAEO,KAAKN,KAAK,GACvCf;gBAEF;YACF,KAAK;gBACHmB,kBAAkBI,IAAAA,UAAI,EAACF,KAAKC,GAAG,EAAE;oBAAER,MAAMO,KAAKP,IAAI,IAAI;oBAASU,KAAK;gBAAM,IAAIxB;gBAC9E;YACF,KAAK;gBACHmB,kBAAkBI,IAAAA,UAAI,EAACF,KAAKC,GAAG,EAAE;oBAAER,MAAMO,KAAKP,IAAI,IAAI;oBAASU,KAAK;gBAAM,IAAIxB;gBAC9E;QACJ;IACF;AACF;AAEA,SAASQ,cAActC,OAAe,EAAEiC,OAA6B,EAAEH,OAAY;IACjF,MAAMM,SAASN,QAAQc,IAAI,CAACW,KAAK,CAAC,MAAMC,KAAK,CAAC,GAAGC,IAAI,CAAC;IACtD,IAAIxB,QAAQyB,IAAI,CAAC,CAACP,OAASA,KAAKhC,IAAI,KAAK,UAAUgC,KAAKN,KAAK,KAAK,UAAU;QAC1Ef,QAAQU,IAAI,CAAC,CAAC,SAAS,EAAExC,QAAQ,0BAA0B,EAAEoC,QAAQ;IACvE,OAAO,IAAIH,QAAQyB,IAAI,CAAC,CAACP,OAASA,KAAKhC,IAAI,KAAK,UAAUgC,KAAKN,KAAK,KAAK,YAAY;QACnFf,QAAQxB,IAAI,CAAC,CAAC,SAAS,EAAEN,QAAQ,4BAA4B,EAAEoC,QAAQ;IACzE,OAAO;QACLN,QAAQ6B,OAAO,CAAC,CAAC,SAAS,EAAE3D,QAAQ,2BAA2B,EAAEoC,QAAQ,EAAEwB,IAAI;IACjF;AACF"}