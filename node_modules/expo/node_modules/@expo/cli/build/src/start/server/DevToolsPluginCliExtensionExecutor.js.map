{"version":3,"sources":["../../../../src/start/server/DevToolsPluginCliExtensionExecutor.ts"],"sourcesContent":["import { spawn } from 'child_process';\nimport path from 'path';\n\nimport {\n  DevToolsPluginExecutorArguments,\n  DevToolsPluginInfo,\n  DevToolsPluginOutput,\n} from './DevToolsPlugin.schema';\nimport { DevToolsPluginCliExtensionResults } from './DevToolsPluginCliExtensionResults';\n\nconst DEFAULT_TIMEOUT_MS = 10_000; // 10 seconds\n\n/**\n * Class that executes CLI Extension commands for a given plugin\n *\n * ## Responsibilities:\n * - Verifies that requested commands exist and have correct parameters\n * - Validates that provided arguments match expected parameter schema\n * - Spawns and manages child processes for command execution\n *  - Captures and streams stdout/stderr data from executed commands\n *  - Manages process errors, timeouts, and unexpected failures\n *  - Enforces execution time limits to prevent hanging processes\n *  - Configures proper execution environment with color support\n *  - Ensures proper cleanup of processes and timeouts\n *  - Provides structured output with exit codes and error states\n */\nexport class DevToolsPluginCliExtensionExecutor {\n  constructor(\n    private plugin: DevToolsPluginInfo,\n    private projectRoot: string,\n    private spawnFunc: typeof spawn = spawn, // Used for injection when testing,\n    private timeoutMs = DEFAULT_TIMEOUT_MS // Timeout for command execution\n  ) {\n    // Validate that this is a plugin with cli extensions\n    if (!this.plugin.cliExtensions?.entryPoint) {\n      throw new Error(`Plugin ${this.plugin.packageName} has no CLI extensions`);\n    }\n  }\n\n  public validate({ command, args }: Omit<DevToolsPluginExecutorArguments, 'metroServerOrigin'>) {\n    const commandElement = this.plugin.cliExtensions?.commands.find((c) => c.name === command);\n    if (!commandElement) {\n      throw new Error(`Command \"${command}\" not found in plugin ${this.plugin.packageName}`);\n    }\n\n    const paramLength = commandElement.parameters?.length ?? 0;\n    const argsLength = Object.keys(args ?? {}).length;\n    if (paramLength !== argsLength) {\n      // Quick check to see if the lengths match\n      throw new Error(\n        `Expected ${paramLength} parameter(s), but got ${argsLength} argument(s) for the command \"${command}\".`\n      );\n    }\n\n    const argsKeys = Object.keys(args ?? {});\n    for (const param of commandElement.parameters ?? []) {\n      const found = argsKeys.find((key) => key === param.name);\n      if (!found) {\n        throw new Error(\n          `Parameter \"${param.name}\" not found in command \"${command}\" of plugin ${this.plugin.packageName}`\n        );\n      }\n    }\n  }\n\n  /** this function is used for testing and showing the command in UI */\n  public getCommandString = ({\n    command,\n    args,\n  }: Omit<DevToolsPluginExecutorArguments, 'metroServerOrigin'>) => {\n    return `node ${this.plugin.cliExtensions!.entryPoint} ${command}${Object.keys(args ?? {}).length > 0 ? ' ' + JSON.stringify(args) : ''}`;\n  };\n\n  public execute = async ({\n    command,\n    args,\n    metroServerOrigin,\n    onOutput,\n  }: DevToolsPluginExecutorArguments): Promise<DevToolsPluginOutput> => {\n    this.validate({ command, args });\n    return new Promise<DevToolsPluginOutput>(async (resolve) => {\n      // Set up the command and its arguments\n      const tool = path.join(this.plugin.packageRoot, this.plugin.cliExtensions!.entryPoint);\n      const child = this.spawnFunc(\n        'node',\n        [tool, command, `${JSON.stringify(args)}`, `${metroServerOrigin}`],\n        {\n          cwd: this.projectRoot,\n          env: { ...process.env },\n        }\n      );\n\n      let finished = false;\n      const pluginResults = new DevToolsPluginCliExtensionResults(onOutput);\n\n      // Collect output/error data\n      child.stdout.on('data', (data) => pluginResults.append(data.toString()));\n      child.stderr.on('data', (data) => pluginResults.append(data.toString(), 'error'));\n\n      // Setup timeout\n      const timeout = setTimeout(() => {\n        if (!finished) {\n          finished = true;\n          child.kill('SIGKILL');\n          pluginResults.append('Command timed out', 'error');\n          resolve(pluginResults.getOutput());\n        }\n      }, this.timeoutMs);\n\n      child.on('close', (code: number) => {\n        if (finished) return;\n        clearTimeout(timeout);\n        finished = true;\n        pluginResults.exit(code);\n        resolve(pluginResults.getOutput());\n      });\n\n      child.on('error', (err: Error) => {\n        if (finished) return;\n        clearTimeout(timeout);\n        finished = true;\n        pluginResults.append(err.toString(), 'error');\n        resolve(pluginResults.getOutput());\n      });\n    });\n  };\n}\n"],"names":["DevToolsPluginCliExtensionExecutor","DEFAULT_TIMEOUT_MS","constructor","plugin","projectRoot","spawnFunc","spawn","timeoutMs","getCommandString","command","args","cliExtensions","entryPoint","Object","keys","length","JSON","stringify","execute","metroServerOrigin","onOutput","validate","Promise","resolve","tool","path","join","packageRoot","child","cwd","env","process","finished","pluginResults","DevToolsPluginCliExtensionResults","stdout","on","data","append","toString","stderr","timeout","setTimeout","kill","getOutput","code","clearTimeout","exit","err","Error","packageName","commandElement","commands","find","c","name","paramLength","parameters","argsLength","argsKeys","param","found","key"],"mappings":"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"}