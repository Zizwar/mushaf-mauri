{"version":3,"sources":["../../../src/export/saveAssets.ts"],"sourcesContent":["/**\n * Copyright Â© 2023 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport type { AssetData } from '@expo/metro/metro';\nimport type { SerialAsset } from '@expo/metro-config/build/serializer/serializerAssets';\nimport chalk from 'chalk';\nimport fs from 'fs';\nimport path from 'path';\n\nimport { Log } from '../log';\nimport { env } from '../utils/env';\n\nlet bytesFormatter: Intl.NumberFormat | undefined | null;\n\nconst prettyBytes = (bytes: number): string => {\n  try {\n    if (bytesFormatter === undefined && typeof Intl === 'object') {\n      bytesFormatter = new Intl.NumberFormat('en', {\n        notation: 'compact',\n        style: 'unit',\n        unit: 'byte',\n        unitDisplay: 'narrow',\n      });\n    }\n    if (bytesFormatter != null) {\n      return bytesFormatter.format(bytes);\n    }\n  } catch {\n    bytesFormatter = null;\n  }\n  // Fall back if ICU is unavailable, which is rare but possible with custom Node.js builds\n  if (bytes >= 900_000) {\n    return `${(bytes / 1_000_000).toFixed(1)}MB`;\n  } else if (bytes >= 900) {\n    return `${(bytes / 1_000).toFixed(1)}KB`;\n  } else {\n    return `${bytes}B`;\n  }\n};\n\nconst BLT = '\\u203A';\n\nexport type BundleOptions = {\n  entryPoint: string;\n  platform: 'android' | 'ios' | 'web';\n  dev?: boolean;\n  minify?: boolean;\n  bytecode: boolean;\n  sourceMapUrl?: string;\n  sourcemaps?: boolean;\n};\n\nexport type BundleAssetWithFileHashes = AssetData & {\n  fileHashes: string[]; // added by the hashAssets asset plugin\n};\n\nexport type BundleOutput = {\n  artifacts: SerialAsset[];\n  assets: readonly BundleAssetWithFileHashes[];\n};\n\nexport type ManifestAsset = { fileHashes: string[]; files: string[]; hash: string };\n\nexport type Asset = ManifestAsset | BundleAssetWithFileHashes;\n\nexport type ExportAssetDescriptor = {\n  contents: string | Buffer;\n  originFilename?: string;\n  /** An identifier for grouping together variations of the same asset. */\n  assetId?: string;\n  /** Expo Router route path for formatting the HTML output. */\n  routeId?: string;\n  /** Expo Router route path for formatting the middleware function output. */\n  middlewareId?: string;\n  /** Expo Router API route path for formatting the server function output. */\n  apiRouteId?: string;\n  /** Expo Router route path for formatting the RSC output. */\n  rscId?: string;\n  /** Expo Router route path for formatting the loader module output. */\n  loaderId?: string;\n  /** A key for grouping together output files by server- or client-side. */\n  targetDomain?: 'server' | 'client';\n};\n\nexport type ExportAssetMap = Map<string, ExportAssetDescriptor>;\n\nexport async function persistMetroFilesAsync(files: ExportAssetMap, outputDir: string) {\n  if (!files.size) {\n    return;\n  }\n  await fs.promises.mkdir(path.join(outputDir), { recursive: true });\n\n  // Test fixtures:\n  // Log.log(\n  //   JSON.stringify(\n  //     Object.fromEntries([...files.entries()].map(([k, v]) => [k, { ...v, contents: '' }]))\n  //   )\n  // );\n\n  const assetEntries: [string, ExportAssetDescriptor][] = [];\n  const apiRouteEntries: [string, ExportAssetDescriptor][] = [];\n  const middlewareEntries: [string, ExportAssetDescriptor][] = [];\n  const routeEntries: [string, ExportAssetDescriptor][] = [];\n  const rscEntries: [string, ExportAssetDescriptor][] = [];\n  const loaderEntries: [string, ExportAssetDescriptor][] = [];\n  const remainingEntries: [string, ExportAssetDescriptor][] = [];\n\n  let hasServerOutput = false;\n  for (const asset of files.entries()) {\n    hasServerOutput = hasServerOutput || asset[1].targetDomain === 'server';\n    if (asset[1].assetId) assetEntries.push(asset);\n    else if (asset[1].routeId != null) routeEntries.push(asset);\n    else if (asset[1].middlewareId != null) middlewareEntries.push(asset);\n    else if (asset[1].apiRouteId != null) apiRouteEntries.push(asset);\n    else if (asset[1].rscId != null) rscEntries.push(asset);\n    else if (asset[1].loaderId != null) loaderEntries.push(asset);\n    else remainingEntries.push(asset);\n  }\n\n  const groups = groupBy(assetEntries, ([, { assetId }]) => assetId!);\n\n  const contentSize = (contents: string | Buffer) => {\n    const length =\n      typeof contents === 'string' ? Buffer.byteLength(contents, 'utf8') : contents.length;\n    return length;\n  };\n\n  const sizeStr = (contents: string | Buffer) => {\n    const length = contentSize(contents);\n    const size = chalk.gray`(${prettyBytes(length)})`;\n    return size;\n  };\n\n  // TODO: If any Expo Router is used, then use a new style which is more simple:\n  // `chalk.gray(/path/to/) + chalk.cyan('route')`\n  // | index.html (1.2kb)\n  // | /path\n  //   | other.html (1.2kb)\n\n  const isExpoRouter = routeEntries.length;\n\n  // Phase out printing all the assets as users can simply check the file system for more info.\n  const showAdditionalInfo = !isExpoRouter || env.EXPO_DEBUG;\n\n  const assetGroups = [...groups.entries()].sort((a, b) => a[0].localeCompare(b[0])) as [\n    string,\n    [string, ExportAssetDescriptor][],\n  ][];\n\n  if (showAdditionalInfo) {\n    if (assetGroups.length) {\n      const totalAssets = assetGroups.reduce((sum, [, assets]) => sum + assets.length, 0);\n\n      Log.log('');\n      Log.log(chalk.bold`${BLT} Assets (${totalAssets}):`);\n\n      for (const [assetId, assets] of assetGroups) {\n        const averageContentSize =\n          assets.reduce((sum, [, { contents }]) => sum + contentSize(contents), 0) / assets.length;\n        Log.log(\n          assetId,\n          chalk.gray(\n            `(${[\n              assets.length > 1 ? `${assets.length} variations` : '',\n              `${prettyBytes(averageContentSize)}`,\n            ]\n              .filter(Boolean)\n              .join(' | ')})`\n          )\n        );\n      }\n    }\n  }\n\n  const bundles: Map<string, [string, ExportAssetDescriptor][]> = new Map();\n  const other: [string, ExportAssetDescriptor][] = [];\n\n  remainingEntries.forEach(([filepath, asset]) => {\n    if (!filepath.match(/_expo\\/(server|static)\\//)) {\n      other.push([filepath, asset]);\n    } else {\n      const platform = filepath.match(/_expo\\/static\\/js\\/([^/]+)\\//)?.[1] ?? 'web';\n      if (!bundles.has(platform)) bundles.set(platform, []);\n\n      bundles.get(platform)!.push([filepath, asset]);\n    }\n  });\n\n  [...bundles.entries()].forEach(([platform, assets]) => {\n    Log.log('');\n    Log.log(chalk.bold`${BLT} ${platform} bundles (${assets.length}):`);\n\n    const allAssets = assets.sort((a, b) => a[0].localeCompare(b[0]));\n    while (allAssets.length) {\n      const [filePath, asset] = allAssets.shift()!;\n      Log.log(filePath, sizeStr(asset.contents));\n      if (filePath.match(/\\.(js|hbc)$/)) {\n        // Get source map\n        const sourceMapIndex = allAssets.findIndex(([fp]) => fp === filePath + '.map');\n        if (sourceMapIndex !== -1) {\n          const [sourceMapFilePath, sourceMapAsset] = allAssets.splice(sourceMapIndex, 1)[0];\n          Log.log(chalk.gray(sourceMapFilePath), sizeStr(sourceMapAsset.contents));\n        }\n      }\n    }\n  });\n\n  if (showAdditionalInfo && other.length) {\n    Log.log('');\n    Log.log(chalk.bold`${BLT} Files (${other.length}):`);\n\n    for (const [filePath, asset] of other.sort((a, b) => a[0].localeCompare(b[0]))) {\n      Log.log(filePath, sizeStr(asset.contents));\n    }\n  }\n\n  if (rscEntries.length) {\n    Log.log('');\n    Log.log(chalk.bold`${BLT} React Server Components (${rscEntries.length}):`);\n\n    for (const [filePath, assets] of rscEntries.sort((a, b) => a[0].length - b[0].length)) {\n      const id = assets.rscId!;\n      Log.log(\n        '/' + (id === '' ? chalk.gray(' (index)') : id),\n        sizeStr(assets.contents),\n        chalk.gray(filePath)\n      );\n    }\n  }\n\n  if (routeEntries.length) {\n    Log.log('');\n    Log.log(chalk.bold`${BLT} Static routes (${routeEntries.length}):`);\n\n    for (const [, assets] of routeEntries.sort((a, b) => a[0].length - b[0].length)) {\n      const id = assets.routeId!;\n      Log.log('/' + (id === '' ? chalk.gray(' (index)') : id), sizeStr(assets.contents));\n    }\n  }\n\n  if (apiRouteEntries.length) {\n    const apiRoutesWithoutSourcemaps = apiRouteEntries.filter(\n      (route) => !route[0].endsWith('.map')\n    );\n    Log.log('');\n    Log.log(chalk.bold`${BLT} API routes (${apiRoutesWithoutSourcemaps.length}):`);\n\n    for (const [apiRouteFilename, assets] of apiRoutesWithoutSourcemaps.sort(\n      (a, b) => a[0].length - b[0].length\n    )) {\n      const id = assets.apiRouteId!;\n      const hasSourceMap = apiRouteEntries.find(\n        ([filename, route]) =>\n          filename !== apiRouteFilename &&\n          route.apiRouteId === assets.apiRouteId &&\n          filename.endsWith('.map')\n      );\n      Log.log(\n        id === '' ? chalk.gray(' (index)') : id,\n        sizeStr(assets.contents),\n        hasSourceMap ? chalk.gray(`(source map ${sizeStr(hasSourceMap[1].contents)})`) : ''\n      );\n    }\n  }\n\n  if (middlewareEntries.length) {\n    const middlewareWithoutSourcemaps = middlewareEntries.filter(\n      (route) => !route[0].endsWith('.map')\n    );\n    Log.log('');\n    Log.log(chalk.bold`${BLT} Middleware:`);\n\n    for (const [middlewareFilename, assets] of middlewareWithoutSourcemaps.sort(\n      (a, b) => a[0].length - b[0].length\n    )) {\n      const id = assets.middlewareId!;\n      const hasSourceMap = middlewareEntries.find(\n        ([filename, route]) =>\n          filename !== middlewareFilename &&\n          route.middlewareId === assets.middlewareId &&\n          filename.endsWith('.map')\n      );\n      Log.log(\n        id,\n        sizeStr(assets.contents),\n        hasSourceMap ? chalk.gray(`(source map ${sizeStr(hasSourceMap[1].contents)})`) : ''\n      );\n    }\n  }\n\n  if (loaderEntries.length) {\n    const loadersWithoutSourcemaps = loaderEntries.filter((entry) => !entry[0].endsWith('.map'));\n    Log.log('');\n    Log.log(chalk.bold`${BLT} Loaders (${loadersWithoutSourcemaps.length}):`);\n\n    for (const [loaderFilename, assets] of loadersWithoutSourcemaps.sort(\n      (a, b) => a[0].length - b[0].length\n    )) {\n      const id = assets.loaderId!;\n      const hasSourceMap = loaderEntries.find(\n        ([filename, entry]) =>\n          filename !== loaderFilename &&\n          entry.loaderId === assets.loaderId &&\n          filename.endsWith('.map')\n      );\n      Log.log(\n        id === '/' ? '/ ' + chalk.gray('(index)') : id,\n        sizeStr(assets.contents),\n        hasSourceMap ? chalk.gray(`(source map ${sizeStr(hasSourceMap[1].contents)})`) : ''\n      );\n    }\n  }\n\n  // Decouple logging from writing for better performance.\n\n  await Promise.all(\n    [...files.entries()]\n      .sort(([a], [b]) => a.localeCompare(b))\n      .map(async ([file, { contents, targetDomain }]) => {\n        // NOTE: Only use `targetDomain` if we have at least one server asset\n        const domain = (hasServerOutput && targetDomain) || '';\n        const outputPath = path.join(outputDir, domain, file);\n        await fs.promises.mkdir(path.dirname(outputPath), { recursive: true });\n        await fs.promises.writeFile(outputPath, contents);\n      })\n  );\n\n  Log.log('');\n}\n\nfunction groupBy<T>(array: T[], key: (item: T) => string): Map<string, T[]> {\n  const map = new Map<string, T[]>();\n  array.forEach((item) => {\n    const group = key(item);\n    const list = map.get(group) ?? [];\n    list.push(item);\n    map.set(group, list);\n  });\n  return map;\n}\n\n// TODO: Move source map modification to the serializer\nexport function getFilesFromSerialAssets(\n  resources: SerialAsset[],\n  {\n    includeSourceMaps,\n    files = new Map(),\n    platform,\n    isServerHosted = platform === 'web',\n  }: {\n    includeSourceMaps: boolean;\n    files?: ExportAssetMap;\n    platform?: string;\n    isServerHosted?: boolean;\n  }\n) {\n  resources.forEach((resource) => {\n    if (resource.type === 'css-external') {\n      return;\n    }\n    files.set(resource.filename, {\n      contents: resource.source,\n      originFilename: resource.originFilename,\n      targetDomain: isServerHosted ? 'client' : undefined,\n    });\n  });\n\n  return files;\n}\n"],"names":["getFilesFromSerialAssets","persistMetroFilesAsync","bytesFormatter","prettyBytes","bytes","undefined","Intl","NumberFormat","notation","style","unit","unitDisplay","format","toFixed","BLT","files","outputDir","size","fs","promises","mkdir","path","join","recursive","assetEntries","apiRouteEntries","middlewareEntries","routeEntries","rscEntries","loaderEntries","remainingEntries","hasServerOutput","asset","entries","targetDomain","assetId","push","routeId","middlewareId","apiRouteId","rscId","loaderId","groups","groupBy","contentSize","contents","length","Buffer","byteLength","sizeStr","chalk","gray","isExpoRouter","showAdditionalInfo","env","EXPO_DEBUG","assetGroups","sort","a","b","localeCompare","totalAssets","reduce","sum","assets","Log","log","bold","averageContentSize","filter","Boolean","bundles","Map","other","forEach","filepath","match","platform","has","set","get","allAssets","filePath","shift","sourceMapIndex","findIndex","fp","sourceMapFilePath","sourceMapAsset","splice","id","apiRoutesWithoutSourcemaps","route","endsWith","apiRouteFilename","hasSourceMap","find","filename","middlewareWithoutSourcemaps","middlewareFilename","loadersWithoutSourcemaps","entry","loaderFilename","Promise","all","map","file","domain","outputPath","dirname","writeFile","array","key","item","group","list","resources","includeSourceMaps","isServerHosted","resource","type","source","originFilename"],"mappings":"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"}